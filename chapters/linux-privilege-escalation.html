
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Linux Privilege Escalation Â· Android Kernel Exploitation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Ashfaq Ansari (@HackSysTeam)">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-atom-dark.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="linux-privilege-escalation.html" />
    
    
    <link rel="prev" href="environment-setup.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html">
            
                    
                    Environment Setup
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#hardware-requirements">
            
                    
                    Hardware Requirements
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#clone-workshop-repository">
            
                    
                    Clone Workshop Repository
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-studio">
            
                    
                    Android Studio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-ndk">
            
                    
                    Android NDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-virtual-device">
            
                    
                    Android Virtual Device
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-kernel-source-code">
            
                    
                    Android Kernel Source Code
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html">
            
                    
                    Linux Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#light-weight-process">
            
                    
                    Light Weight Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#process-credentials">
            
                    
                    Process Credentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux">
            
                    
                    SELinux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux-enforcing">
            
                    
                    selinux_enforcing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#seccomp">
            
                    
                    SecComp
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html">
            
                    
                    Vulnerability Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#original-discovery">
            
                    
                    Original Discovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#rediscovery">
            
                    
                    Rediscovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#patch">
            
                    
                    Patch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html">
            
                    
                    Vulnerability Trigger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#reintroduction">
            
                    
                    Reintroduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#build-kernel-with-kasan">
            
                    
                    Build Kernel With KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#boot-kernel">
            
                    
                    Boot Kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#crash">
            
                    
                    Crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#kasan-symbolizer">
            
                    
                    KASan Symbolizer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html">
            
                    
                    Scripted Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html#kernel-debugging">
            
                    
                    Kernel Debugging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html">
            
                    
                    Root Cause Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash">
            
                    
                    Revisiting Crash
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-allocation">
            
                    
                    Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-free">
            
                    
                    Free
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-use">
            
                    
                    Use
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#visual-studio-code">
            
                    
                    Visual Studio Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis">
            
                    
                    Static Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-open">
            
                    
                    open
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-create">
            
                    
                    epoll_create
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-ctl">
            
                    
                    epoll_ctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ioctl">
            
                    
                    ioctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.5" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ep-remove">
            
                    
                    ep_remove
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.6" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis-recap">
            
                    
                    Static Analysis Recap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#dynamic-analysis">
            
                    
                    Dynamic Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#hw-cpu-ncore">
            
                    
                    hw.cpu.ncore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#build-kernel-without-kasan">
            
                    
                    Build Kernel Without KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#kernel-tracing">
            
                    
                    Kernel Tracing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="exploitation.html">
            
                <a href="exploitation.html">
            
                    
                    Exploitation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="exploitation.html">
            
                <a href="exploitation.html#primitive">
            
                    
                    Primitive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="exploitation.html">
            
                <a href="exploitation.html#corruption-target">
            
                    
                    Corruption Target
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="exploitation.html">
            
                <a href="exploitation.html#leaking-task-struct-pointer">
            
                    
                    Leaking task_struct*
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="exploitation.html">
            
                <a href="exploitation.html#clobber-addr-limit">
            
                    
                    Clobber addr_limit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="exploitation.html">
            
                <a href="exploitation.html#exploit-in-action">
            
                    
                    Exploit In Action
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="gdb-macros.html">
            
                <a href="gdb-macros.html">
            
                    
                    GDB Macros
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="resources.html">
            
                <a href="resources.html">
            
                    
                    Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Linux Privilege Escalation</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="linux-privilege-escalation">Linux Privilege Escalation</h1>
<p>The end goal of this workshop is to use a <strong>Android</strong> kernel <strong>vulnerability</strong> to achieve privilege escalation i.e <code>root</code>. In <strong>Linux</strong> <code>root</code> is the super user with <code>uid=0(root) gid=0(root)</code> and has all the access rights.</p>
<h2 id="light-weight-process">Light Weight Process </h2>
<p>Linux uses <strong>Light Weight Process</strong> to implement better support multi-threading. Each <strong>light weight process</strong> is assigned a process descriptor called <code>task_struct</code> and is defined in <code>include/linux/sched.h</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span>
        <span class="token comment">/*
         * For reasons of header soup (see current_thread_info()), this
         * must be the first element of task_struct.
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">thread_info</span>              thread_info<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped: */</span>
        <span class="token keyword">volatile</span> <span class="token keyword">long</span>                   state<span class="token punctuation">;</span>

        <span class="token comment">/*
         * This begins the randomizable portion of task_struct. Only
         * scheduling-critical items should be added above here.
         */</span>
        randomized_struct_fields_start

        <span class="token keyword">void</span>                            <span class="token operator">*</span>stack<span class="token punctuation">;</span>
        atomic_t                        usage<span class="token punctuation">;</span>
        <span class="token comment">/* Per task flags (PF_*), defined further below: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    flags<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    ptrace<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SMP</span>
        <span class="token keyword">struct</span> <span class="token class-name">llist_node</span>               wake_entry<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             on_cpu<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span>
        <span class="token comment">/* Current CPU: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    cpu<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    wakee_flips<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   wakee_flip_decay_ts<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span>              <span class="token operator">*</span>last_wakee<span class="token punctuation">;</span>

        <span class="token keyword">int</span>                             wake_cpu<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">int</span>                             on_rq<span class="token punctuation">;</span>

        <span class="token keyword">int</span>                             prio<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             static_prio<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             normal_prio<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    rt_priority<span class="token punctuation">;</span>

        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sched_class</span>        <span class="token operator">*</span>sched_class<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sched_entity</span>             se<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sched_rt_entity</span>          rt<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SCHED_WALT</span>
        <span class="token keyword">struct</span> <span class="token class-name">ravg</span> ravg<span class="token punctuation">;</span>
        <span class="token comment">/*
         * &apos;init_load_pct&apos; represents the initial task load assigned to children
         * of this task
         */</span>
        u32 init_load_pct<span class="token punctuation">;</span>
        u64 last_sleep_ts<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_CGROUP_SCHED</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_group</span>               <span class="token operator">*</span>sched_task_group<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">sched_dl_entity</span>          dl<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PREEMPT_NOTIFIERS</span>
        <span class="token comment">/* List of struct preempt_notifier: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">hlist_head</span>               preempt_notifiers<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_BLK_DEV_IO_TRACE</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    btrace_seq<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    policy<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             nr_cpus_allowed<span class="token punctuation">;</span>
        cpumask_t                       cpus_allowed<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PREEMPT_RCU</span>
        <span class="token keyword">int</span>                             rcu_read_lock_nesting<span class="token punctuation">;</span>
        <span class="token keyword">union</span> rcu_special               rcu_read_unlock_special<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                rcu_node_entry<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">rcu_node</span>                 <span class="token operator">*</span>rcu_blocked_node<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* #ifdef CONFIG_PREEMPT_RCU */</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_TASKS_RCU</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   rcu_tasks_nvcsw<span class="token punctuation">;</span>
        u8                              rcu_tasks_holdout<span class="token punctuation">;</span>
        u8                              rcu_tasks_idx<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             rcu_tasks_idle_cpu<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                rcu_tasks_holdout_list<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* #ifdef CONFIG_TASKS_RCU */</span>

        <span class="token keyword">struct</span> <span class="token class-name">sched_info</span>               sched_info<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                tasks<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SMP</span>
        <span class="token keyword">struct</span> <span class="token class-name">plist_node</span>               pushable_tasks<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">rb_node</span>                  pushable_dl_tasks<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token keyword">struct</span> <span class="token class-name">mm_struct</span>                <span class="token operator">*</span>mm<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mm_struct</span>                <span class="token operator">*</span>active_mm<span class="token punctuation">;</span>

        <span class="token comment">/* Per-thread vma caching: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">vmacache</span>                 vmacache<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> SPLIT_RSS_COUNTING</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_rss_stat</span>            rss_stat<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">int</span>                             exit_state<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             exit_code<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             exit_signal<span class="token punctuation">;</span>
        <span class="token comment">/* The signal sent when the parent dies: */</span>
        <span class="token keyword">int</span>                             pdeath_signal<span class="token punctuation">;</span>
        <span class="token comment">/* JOBCTL_*, siglock protected: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   jobctl<span class="token punctuation">;</span>

        <span class="token comment">/* Used for emulating ABI behavior of previous Linux versions: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    personality<span class="token punctuation">;</span>

        <span class="token comment">/* Scheduler bits, serialized by scheduler locks: */</span>
        <span class="token keyword">unsigned</span>                        sched_reset_on_fork<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span>                        sched_contributes_to_load<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span>                        sched_migrated<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span>                        sched_remote_wakeup<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PSI</span>
        <span class="token keyword">unsigned</span>                        sched_psi_wake_requeue<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token comment">/* Force alignment to the next boundary: */</span>
        <span class="token keyword">unsigned</span>                        <span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/* Unserialized, strictly &apos;current&apos; */</span>

        <span class="token comment">/* Bit to tell LSMs we&apos;re in execve(): */</span>
        <span class="token keyword">unsigned</span>                        in_execve<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span>                        in_iowait<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> TIF_RESTORE_SIGMASK</span>
        <span class="token keyword">unsigned</span>                        restore_sigmask<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_MEMCG</span>
        <span class="token keyword">unsigned</span>                        memcg_may_oom<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifndef</span> CONFIG_SLOB</span>
        <span class="token keyword">unsigned</span>                        memcg_kmem_skip_account<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_COMPAT_BRK</span>
        <span class="token keyword">unsigned</span>                        brk_randomized<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_CGROUPS</span>
        <span class="token comment">/* disallow userland-initiated cgroup migration */</span>
        <span class="token keyword">unsigned</span>                        no_cgroup_migration<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   atomic_flags<span class="token punctuation">;</span> <span class="token comment">/* Flags requiring atomic access. */</span>

        <span class="token keyword">struct</span> <span class="token class-name">restart_block</span>            restart_block<span class="token punctuation">;</span>

        pid_t                           pid<span class="token punctuation">;</span>
        pid_t                           tgid<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_CC_STACKPROTECTOR</span>
        <span class="token comment">/* Canary value for the -fstack-protector GCC feature: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   stack_canary<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">/*
         * Pointers to the (original) parent process, youngest child, younger sibling,
         * older sibling, respectively.  (p-&gt;father can be replaced with
         * p-&gt;real_parent-&gt;pid)
         */</span>

        <span class="token comment">/* Real parent process: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> __rcu        <span class="token operator">*</span>real_parent<span class="token punctuation">;</span>

        <span class="token comment">/* Recipient of SIGCHLD, wait4() reports: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> __rcu        <span class="token operator">*</span>parent<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Children/sibling form the list of natural children:
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                children<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                sibling<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span>              <span class="token operator">*</span>group_leader<span class="token punctuation">;</span>

        <span class="token comment">/*
         * &apos;ptraced&apos; is the list of tasks this task is using ptrace() on.
         *
         * This includes both natural children and PTRACE_ATTACH targets.
         * &apos;ptrace_entry&apos; is this task&apos;s link on the p-&gt;parent-&gt;ptraced list.
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                ptraced<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                ptrace_entry<span class="token punctuation">;</span>

        <span class="token comment">/* PID/PID hash table linkage. */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pid_link</span>                 pids<span class="token punctuation">[</span>PIDTYPE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                thread_group<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                thread_node<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">completion</span>               <span class="token operator">*</span>vfork_done<span class="token punctuation">;</span>

        <span class="token comment">/* CLONE_CHILD_SETTID: */</span>
        <span class="token keyword">int</span> __user                      <span class="token operator">*</span>set_child_tid<span class="token punctuation">;</span>

        <span class="token comment">/* CLONE_CHILD_CLEARTID: */</span>
        <span class="token keyword">int</span> __user                      <span class="token operator">*</span>clear_child_tid<span class="token punctuation">;</span>

        u64                             utime<span class="token punctuation">;</span>
        u64                             stime<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_ARCH_HAS_SCALED_CPUTIME</span>
        u64                             utimescaled<span class="token punctuation">;</span>
        u64                             stimescaled<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        u64                             gtime<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_CPU_FREQ_TIMES</span>
        u64                             <span class="token operator">*</span>time_in_state<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    max_state<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">prev_cputime</span>             prev_cputime<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_VIRT_CPU_ACCOUNTING_GEN</span>
        <span class="token keyword">struct</span> <span class="token class-name">vtime</span>                    vtime<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_NO_HZ_FULL</span>
        atomic_t                        tick_dep_mask<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">/* Context switch counts: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   nvcsw<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   nivcsw<span class="token punctuation">;</span>

        <span class="token comment">/* Monotonic time in nsecs: */</span>
        u64                             start_time<span class="token punctuation">;</span>

        <span class="token comment">/* Boot based time in nsecs: */</span>
        u64                             real_start_time<span class="token punctuation">;</span>

        <span class="token comment">/* MM fault and swap info: this can arguably be seen as either mm-specific or thread-specific: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   min_flt<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   maj_flt<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_POSIX_TIMERS</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_cputime</span>             cputime_expires<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                cpu_timers<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token comment">/* Process credentials: */</span>

        <span class="token comment">/* Tracer&apos;s credentials at attach: */</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> __rcu         <span class="token operator">*</span>ptracer_cred<span class="token punctuation">;</span>

        <span class="token comment">/* Objective and real subjective task credentials (COW): */</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> __rcu         <span class="token operator">*</span>real_cred<span class="token punctuation">;</span>

        <span class="token comment">/* Effective (overridable) subjective task credentials (COW): */</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> __rcu         <span class="token operator">*</span>cred<span class="token punctuation">;</span>

        <span class="token comment">/*
         * executable name, excluding path.
         *
         * - normally initialized setup_new_exec()
         * - access it with [gs]et_task_comm()
         * - lock it with task_lock()
         */</span>
        <span class="token keyword">char</span>                            comm<span class="token punctuation">[</span>TASK_COMM_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">nameidata</span>                <span class="token operator">*</span>nameidata<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SYSVIPC</span>
        <span class="token keyword">struct</span> <span class="token class-name">sysv_sem</span>                 sysvsem<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sysv_shm</span>                 sysvshm<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DETECT_HUNG_TASK</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   last_switch_count<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">/* Filesystem information: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">fs_struct</span>                <span class="token operator">*</span>fs<span class="token punctuation">;</span>

        <span class="token comment">/* Open file information: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">files_struct</span>             <span class="token operator">*</span>files<span class="token punctuation">;</span>

        <span class="token comment">/* Namespaces: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">nsproxy</span>                  <span class="token operator">*</span>nsproxy<span class="token punctuation">;</span>

        <span class="token comment">/* Signal handlers: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">signal_struct</span>            <span class="token operator">*</span>signal<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sighand_struct</span>           <span class="token operator">*</span>sighand<span class="token punctuation">;</span>
        sigset_t                        blocked<span class="token punctuation">;</span>
        sigset_t                        real_blocked<span class="token punctuation">;</span>
        <span class="token comment">/* Restored if set_restore_sigmask() was used: */</span>
        sigset_t                        saved_sigmask<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sigpending</span>               pending<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   sas_ss_sp<span class="token punctuation">;</span>
        size_t                          sas_ss_size<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    sas_ss_flags<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">callback_head</span>            <span class="token operator">*</span>task_works<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">audit_context</span>            <span class="token operator">*</span>audit_context<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_AUDITSYSCALL</span>
        kuid_t                          loginuid<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    sessionid<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">seccomp</span>                  seccomp<span class="token punctuation">;</span>

        <span class="token comment">/* Thread group tracking: */</span>
        u32                             parent_exec_id<span class="token punctuation">;</span>
        u32                             self_exec_id<span class="token punctuation">;</span>

        <span class="token comment">/* Protection against (de-)allocation: mm, files, fs, tty, keyrings, mems_allowed, mempolicy: */</span>
        spinlock_t                      alloc_lock<span class="token punctuation">;</span>

        <span class="token comment">/* Protection of the PI data structures: */</span>
        raw_spinlock_t                  pi_lock<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">wake_q_node</span>              wake_q<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_RT_MUTEXES</span>
        <span class="token comment">/* PI waiters blocked on a rt_mutex held by this task: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">rb_root_cached</span>           pi_waiters<span class="token punctuation">;</span>
        <span class="token comment">/* Updated under owner&apos;s pi_lock and rq lock */</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span>              <span class="token operator">*</span>pi_top_task<span class="token punctuation">;</span>
        <span class="token comment">/* Deadlock detection and priority inheritance handling: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">rt_mutex_waiter</span>          <span class="token operator">*</span>pi_blocked_on<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_MUTEXES</span>
        <span class="token comment">/* Mutex deadlock detection: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex_waiter</span>             <span class="token operator">*</span>blocked_on<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_TRACE_IRQFLAGS</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    irq_events<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   hardirq_enable_ip<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   hardirq_disable_ip<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    hardirq_enable_event<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    hardirq_disable_event<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             hardirqs_enabled<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             hardirq_context<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   softirq_disable_ip<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   softirq_enable_ip<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    softirq_disable_event<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    softirq_enable_event<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             softirqs_enabled<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             softirq_context<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_LOCKDEP</span>
<span class="token macro property"># <span class="token directive keyword">define</span> MAX_LOCK_DEPTH                 48UL</span>
        u64                             curr_chain_key<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             lockdep_depth<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    lockdep_recursion<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">held_lock</span>                held_locks<span class="token punctuation">[</span>MAX_LOCK_DEPTH<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_LOCKDEP_CROSSRELEASE</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_XHLOCKS_NR 64UL</span>
        <span class="token keyword">struct</span> <span class="token class-name">hist_lock</span> <span class="token operator">*</span>xhlocks<span class="token punctuation">;</span> <span class="token comment">/* Crossrelease history locks */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> xhlock_idx<span class="token punctuation">;</span>
        <span class="token comment">/* For restoring at history boundaries */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> xhlock_idx_hist<span class="token punctuation">[</span>XHLOCK_CTX_NR<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> hist_id<span class="token punctuation">;</span>
        <span class="token comment">/* For overwrite check at each context exit */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> hist_id_save<span class="token punctuation">[</span>XHLOCK_CTX_NR<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_UBSAN</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    in_ubsan<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token comment">/* Journalling filesystem info: */</span>
        <span class="token keyword">void</span>                            <span class="token operator">*</span>journal_info<span class="token punctuation">;</span>

        <span class="token comment">/* Stacked block device info: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">bio_list</span>                 <span class="token operator">*</span>bio_list<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_BLOCK</span>
        <span class="token comment">/* Stack plugging: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">blk_plug</span>                 <span class="token operator">*</span>plug<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token comment">/* VM state: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">reclaim_state</span>            <span class="token operator">*</span>reclaim_state<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">backing_dev_info</span>         <span class="token operator">*</span>backing_dev_info<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">io_context</span>               <span class="token operator">*</span>io_context<span class="token punctuation">;</span>

        <span class="token comment">/* Ptrace state: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   ptrace_message<span class="token punctuation">;</span>
        siginfo_t                       <span class="token operator">*</span>last_siginfo<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">task_io_accounting</span>       ioac<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PSI</span>
        <span class="token comment">/* Pressure stall state */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    psi_flags<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_TASK_XACCT</span>
        <span class="token comment">/* Accumulated RSS usage: */</span>
        u64                             acct_rss_mem1<span class="token punctuation">;</span>
        <span class="token comment">/* Accumulated virtual memory usage: */</span>
        u64                             acct_vm_mem1<span class="token punctuation">;</span>
        <span class="token comment">/* stime + utime since last update: */</span>
        u64                             acct_timexpd<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_CPUSETS</span>
        <span class="token comment">/* Protected by -&gt;alloc_lock: */</span>
        nodemask_t                      mems_allowed<span class="token punctuation">;</span>
        <span class="token comment">/* Seqence number to catch updates: */</span>
        seqcount_t                      mems_allowed_seq<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             cpuset_mem_spread_rotor<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             cpuset_slab_spread_rotor<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_CGROUPS</span>
        <span class="token comment">/* Control Group info protected by css_set_lock: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">css_set</span> __rcu            <span class="token operator">*</span>cgroups<span class="token punctuation">;</span>
        <span class="token comment">/* cg_list protected by css_set_lock and tsk-&gt;alloc_lock: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                cg_list<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_INTEL_RDT</span>
        u32                             closid<span class="token punctuation">;</span>
        u32                             rmid<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_FUTEX</span>
        <span class="token keyword">struct</span> <span class="token class-name">robust_list_head</span> __user  <span class="token operator">*</span>robust_list<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_COMPAT</span>
        <span class="token keyword">struct</span> <span class="token class-name">compat_robust_list_head</span> __user <span class="token operator">*</span>compat_robust_list<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                pi_state_list<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">futex_pi_state</span>           <span class="token operator">*</span>pi_state_cache<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_PERF_EVENTS</span>
        <span class="token keyword">struct</span> <span class="token class-name">perf_event_context</span>       <span class="token operator">*</span>perf_event_ctxp<span class="token punctuation">[</span>perf_nr_task_contexts<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span>                    perf_event_mutex<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                perf_event_list<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_PREEMPT</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   preempt_disable_ip<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_NUMA</span>
        <span class="token comment">/* Protected by alloc_lock: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">mempolicy</span>                <span class="token operator">*</span>mempolicy<span class="token punctuation">;</span>
        <span class="token keyword">short</span>                           il_prev<span class="token punctuation">;</span>
        <span class="token keyword">short</span>                           pref_node_fork<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_NUMA_BALANCING</span>
        <span class="token keyword">int</span>                             numa_scan_seq<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    numa_scan_period<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    numa_scan_period_max<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             numa_preferred_nid<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   numa_migrate_retry<span class="token punctuation">;</span>
        <span class="token comment">/* Migration stamp: */</span>
        u64                             node_stamp<span class="token punctuation">;</span>
        u64                             last_task_numa_placement<span class="token punctuation">;</span>
        u64                             last_sum_exec_runtime<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">callback_head</span>            numa_work<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">list_head</span>                numa_entry<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">numa_group</span>               <span class="token operator">*</span>numa_group<span class="token punctuation">;</span>

        <span class="token comment">/*
         * numa_faults is an array split into four regions:
         * faults_memory, faults_cpu, faults_memory_buffer, faults_cpu_buffer
         * in this precise order.
         *
         * faults_memory: Exponential decaying average of faults on a per-node
         * basis. Scheduling placement decisions are made based on these
         * counts. The values remain static for the duration of a PTE scan.
         * faults_cpu: Track the nodes the process was running on when a NUMA
         * hinting fault was incurred.
         * faults_memory_buffer and faults_cpu_buffer: Record faults per node
         * during the current scan window. When the scan completes, the counts
         * in faults_memory and faults_cpu decay and these values are copied.
         */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   <span class="token operator">*</span>numa_faults<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   total_numa_faults<span class="token punctuation">;</span>

        <span class="token comment">/*
         * numa_faults_locality tracks if faults recorded during the last
         * scan window were remote/local or failed to migrate. The task scan
         * period is adapted based on the locality of the faults with different
         * weights depending on whether they were shared or private faults
         */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   numa_faults_locality<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   numa_pages_migrated<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* CONFIG_NUMA_BALANCING */</span>

        <span class="token keyword">struct</span> <span class="token class-name">tlbflush_unmap_batch</span>     tlb_ubc<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span>                 rcu<span class="token punctuation">;</span>

        <span class="token comment">/* Cache last used pipe for splice(): */</span>
        <span class="token keyword">struct</span> <span class="token class-name">pipe_inode_info</span>          <span class="token operator">*</span>splice_pipe<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">page_frag</span>                task_frag<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_TASK_DELAY_ACCT</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_delay_info</span>          <span class="token operator">*</span>delays<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_FAULT_INJECTION</span>
        <span class="token keyword">int</span>                             make_it_fail<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    fail_nth<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">/*
         * When (nr_dirtied &gt;= nr_dirtied_pause), it&apos;s time to call
         * balance_dirty_pages() for a dirty throttling pause:
         */</span>
        <span class="token keyword">int</span>                             nr_dirtied<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             nr_dirtied_pause<span class="token punctuation">;</span>
        <span class="token comment">/* Start of a write-and-pause period: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   dirty_paused_when<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_LATENCYTOP</span>
        <span class="token keyword">int</span>                             latency_record_count<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">latency_record</span>           latency_record<span class="token punctuation">[</span>LT_SAVECOUNT<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token comment">/*
         * Time slack values; these are used to round up poll() and
         * select() etc timeout values. These are in nanoseconds.
         */</span>
        u64                             timer_slack_ns<span class="token punctuation">;</span>
        u64                             default_timer_slack_ns<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_KASAN</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    kasan_depth<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_FUNCTION_GRAPH_TRACER</span>
        <span class="token comment">/* Index of current stored address in ret_stack: */</span>
        <span class="token keyword">int</span>                             curr_ret_stack<span class="token punctuation">;</span>

        <span class="token comment">/* Stack of return addresses for return function tracing: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">ftrace_ret_stack</span>         <span class="token operator">*</span>ret_stack<span class="token punctuation">;</span>

        <span class="token comment">/* Timestamp for last schedule: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">long</span>              ftrace_timestamp<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Number of functions that haven&apos;t been traced
         * because of depth overrun:
         */</span>
        atomic_t                        trace_overrun<span class="token punctuation">;</span>

        <span class="token comment">/* Pause tracing: */</span>
        atomic_t                        tracing_graph_pause<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_TRACING</span>
        <span class="token comment">/* State flags for use by tracers: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   trace<span class="token punctuation">;</span>

        <span class="token comment">/* Bitmask and counter of trace recursion: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   trace_recursion<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">/* CONFIG_TRACING */</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_KCOV</span>
        <span class="token comment">/* Coverage collection mode enabled for this task (0 if disabled): */</span>
        <span class="token keyword">enum</span> <span class="token class-name">kcov_mode</span>                  kcov_mode<span class="token punctuation">;</span>

        <span class="token comment">/* Size of the kcov_area: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    kcov_size<span class="token punctuation">;</span>

        <span class="token comment">/* Buffer for coverage collection: */</span>
        <span class="token keyword">void</span>                            <span class="token operator">*</span>kcov_area<span class="token punctuation">;</span>

        <span class="token comment">/* KCOV descriptor wired with this task or NULL: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">kcov</span>                     <span class="token operator">*</span>kcov<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_MEMCG</span>
        <span class="token keyword">struct</span> <span class="token class-name">mem_cgroup</span>               <span class="token operator">*</span>memcg_in_oom<span class="token punctuation">;</span>
        gfp_t                           memcg_oom_gfp_mask<span class="token punctuation">;</span>
        <span class="token keyword">int</span>                             memcg_oom_order<span class="token punctuation">;</span>

        <span class="token comment">/* Number of pages to reclaim on returning to userland: */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    memcg_nr_pages_over_high<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_UPROBES</span>
        <span class="token keyword">struct</span> <span class="token class-name">uprobe_task</span>              <span class="token operator">*</span>utask<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(CONFIG_BCACHE) || defined(CONFIG_BCACHE_MODULE)</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    sequential_io<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span>                    sequential_io_avg<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_ATOMIC_SLEEP</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span>                   task_state_change<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">int</span>                             pagefault_disabled<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_MMU</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span>              <span class="token operator">*</span>oom_reaper_list<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_VMAP_STACK</span>
        <span class="token keyword">struct</span> <span class="token class-name">vm_struct</span>                <span class="token operator">*</span>stack_vm_area<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_THREAD_INFO_IN_TASK</span>
        <span class="token comment">/* A live task holds one reference: */</span>
        atomic_t                        stack_refcount<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_LIVEPATCH</span>
        <span class="token keyword">int</span> patch_state<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SECURITY</span>
        <span class="token comment">/* Used by LSM modules for access restriction: */</span>
        <span class="token keyword">void</span>                            <span class="token operator">*</span>security<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

        <span class="token comment">/*
         * New fields for task_struct should be added above here, so that
         * they are included in the randomized portion of task_struct.
         */</span>
        randomized_struct_fields_end

        <span class="token comment">/* CPU-specific state of this task: */</span>
        <span class="token keyword">struct</span> <span class="token class-name">thread_struct</span>            thread<span class="token punctuation">;</span>

        <span class="token comment">/*
         * WARNING: on x86, &apos;thread_struct&apos; contains a variable-sized
         * structure.  It *MUST* be at the end of &apos;task_struct&apos;.
         *
         * Do not put anything below here!
         */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>This data structure contains all the information to manage a process. One of the interesting members in this <code>task_struct</code> structure is <code>cred</code>.</p>
<h2 id="process-credentials">Process Credentials </h2>
<p>The <strong>security context</strong> of a task is defined by <code>struct cred</code> and is defined in <code>include/linux/cred.h</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token punctuation">{</span>
        atomic_t        usage<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span>
        atomic_t        subscribers<span class="token punctuation">;</span>    <span class="token comment">/* number of processes subscribed */</span>
        <span class="token keyword">void</span>            <span class="token operator">*</span>put_addr<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span>        magic<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CRED_MAGIC      0x43736564</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        kuid_t          uid<span class="token punctuation">;</span>            <span class="token comment">/* real UID of the task */</span>
        kgid_t          gid<span class="token punctuation">;</span>            <span class="token comment">/* real GID of the task */</span>
        kuid_t          suid<span class="token punctuation">;</span>           <span class="token comment">/* saved UID of the task */</span>
        kgid_t          sgid<span class="token punctuation">;</span>           <span class="token comment">/* saved GID of the task */</span>
        kuid_t          euid<span class="token punctuation">;</span>           <span class="token comment">/* effective UID of the task */</span>
        kgid_t          egid<span class="token punctuation">;</span>           <span class="token comment">/* effective GID of the task */</span>
        kuid_t          fsuid<span class="token punctuation">;</span>          <span class="token comment">/* UID for VFS ops */</span>
        kgid_t          fsgid<span class="token punctuation">;</span>          <span class="token comment">/* GID for VFS ops */</span>
        <span class="token keyword">unsigned</span>        securebits<span class="token punctuation">;</span>     <span class="token comment">/* SUID-less security management */</span>
        kernel_cap_t    cap_inheritable<span class="token punctuation">;</span> <span class="token comment">/* caps our children can inherit */</span>
        kernel_cap_t    cap_permitted<span class="token punctuation">;</span>  <span class="token comment">/* caps we&apos;re permitted */</span>
        kernel_cap_t    cap_effective<span class="token punctuation">;</span>  <span class="token comment">/* caps we can actually use */</span>
        kernel_cap_t    cap_bset<span class="token punctuation">;</span>       <span class="token comment">/* capability bounding set */</span>
        kernel_cap_t    cap_ambient<span class="token punctuation">;</span>    <span class="token comment">/* Ambient capability set */</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_KEYS</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   jit_keyring<span class="token punctuation">;</span>    <span class="token comment">/* default keyring to attach requested
                                         * keys to */</span>
        <span class="token keyword">struct</span> <span class="token class-name">key</span> __rcu <span class="token operator">*</span>session_keyring<span class="token punctuation">;</span> <span class="token comment">/* keyring inherited over fork */</span>
        <span class="token keyword">struct</span> <span class="token class-name">key</span>      <span class="token operator">*</span>process_keyring<span class="token punctuation">;</span> <span class="token comment">/* keyring private to this process */</span>
        <span class="token keyword">struct</span> <span class="token class-name">key</span>      <span class="token operator">*</span>thread_keyring<span class="token punctuation">;</span> <span class="token comment">/* keyring private to this thread */</span>
        <span class="token keyword">struct</span> <span class="token class-name">key</span>      <span class="token operator">*</span>request_key_auth<span class="token punctuation">;</span> <span class="token comment">/* assumed request_key authority */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SECURITY</span>
        <span class="token keyword">void</span>            <span class="token operator">*</span>security<span class="token punctuation">;</span>      <span class="token comment">/* subjective LSM security */</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">struct</span> <span class="token class-name">user_struct</span> <span class="token operator">*</span>user<span class="token punctuation">;</span>       <span class="token comment">/* real user ID subscription */</span>
        <span class="token keyword">struct</span> <span class="token class-name">user_namespace</span> <span class="token operator">*</span>user_ns<span class="token punctuation">;</span> <span class="token comment">/* user_ns the caps and keyrings are relative to. */</span>
        <span class="token keyword">struct</span> <span class="token class-name">group_info</span> <span class="token operator">*</span>group_info<span class="token punctuation">;</span>  <span class="token comment">/* supplementary groups for euid/fsgid */</span>
        <span class="token comment">/* RCU deletion */</span>
        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> non_rcu<span class="token punctuation">;</span>                    <span class="token comment">/* Can we skip RCU deletion? */</span>
                <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span> rcu<span class="token punctuation">;</span>            <span class="token comment">/* RCU deletion hook */</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> __randomize_layout<span class="token punctuation">;</span>
</code></pre>
<p>In most of the Linux <strong>kernel exploits</strong>, you must have seen that to achieve <code>root</code> they use </p>
<pre class="language-"><code class="lang-c"><span class="token function">commit_creds</span><span class="token punctuation">(</span><span class="token function">prepare_kernel_cred</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s try to look into these two functions and see what they do. First, let&apos;s look into <code>prepare_kernel_cred</code> function which is defined in <code>kernel/cred.c</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span><span class="token function">prepare_kernel_cred</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>daemon<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>new<span class="token punctuation">;</span>

        new <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>cred_jar<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>new<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token function">kdebug</span><span class="token punctuation">(</span><span class="token string">&quot;prepare_kernel_cred() alloc %p&quot;</span><span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>daemon<span class="token punctuation">)</span>
                old <span class="token operator">=</span> <span class="token function">get_task_cred</span><span class="token punctuation">(</span>daemon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
                old <span class="token operator">=</span> <span class="token function">get_cred</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>init_cred<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">validate_creds</span><span class="token punctuation">(</span>old<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token operator">*</span>new <span class="token operator">=</span> <span class="token operator">*</span>old<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">validate_creds</span><span class="token punctuation">(</span>new<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> new<span class="token punctuation">;</span>

error<span class="token operator">:</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This function basically take a pointer <code>task_struct</code> for which we want to prepare <em>kernel credentials</em>. The important part of the function is that if we provide <code>NULL</code> as the pointer to <code>task_struct</code> it will get the default credentials which is <code>init_cred</code>. <code>init_cred</code> is a global <code>struct cred</code> defined in <code>kernel/cred.c</code> which is used to initialize the credentials for the <code>init_task</code> which is the first <strong>task</strong> in Linux.</p>
<pre class="language-"><code class="lang-c"><span class="token comment">/*
 * The initial credentials for the initial task
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">cred</span> init_cred <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>usage                  <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span>
        <span class="token punctuation">.</span>subscribers            <span class="token operator">=</span> <span class="token function">ATOMIC_INIT</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>magic                  <span class="token operator">=</span> CRED_MAGIC<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token punctuation">.</span>uid                    <span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>gid                    <span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>suid                   <span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>sgid                   <span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>euid                   <span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>egid                   <span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>fsuid                  <span class="token operator">=</span> GLOBAL_ROOT_UID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>fsgid                  <span class="token operator">=</span> GLOBAL_ROOT_GID<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>securebits             <span class="token operator">=</span> SECUREBITS_DEFAULT<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>cap_inheritable        <span class="token operator">=</span> CAP_EMPTY_SET<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>cap_permitted          <span class="token operator">=</span> CAP_FULL_SET<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>cap_effective          <span class="token operator">=</span> CAP_FULL_SET<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>cap_bset               <span class="token operator">=</span> CAP_FULL_SET<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>user                   <span class="token operator">=</span> INIT_USER<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>user_ns                <span class="token operator">=</span> <span class="token operator">&amp;</span>init_user_ns<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>group_info             <span class="token operator">=</span> <span class="token operator">&amp;</span>init_groups<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s look at what these defines mean.</p>
<pre class="language-"><code class="lang-c"><span class="token macro property">#<span class="token directive keyword">define</span> GLOBAL_ROOT_UID     (uint32_t)0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> GLOBAL_ROOT_GID     (uint32_t)0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SECUREBITS_DEFAULT  (uint32_t)0x00000000</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CAP_EMPTY_SET       (uint64_t)0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> CAP_FULL_SET        (uint64_t)0x3FFFFFFFFF</span>
</code></pre>
<p><code>init_cred</code> basically sets the <code>cred</code> structure as shown below.</p>
<pre class="language-"><code class="lang-c">cred<span class="token operator">-&gt;</span>uid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>gid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>suid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>idid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>euid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>egid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>fsuid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>fsgid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>securebits <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_inheritable<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_inheritable<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_permitted<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3F</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_permitted<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_effective<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3F</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_effective<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_bset<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3F</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_bset<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_ambient<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
cred<span class="token operator">-&gt;</span>cap_ambient<span class="token punctuation">.</span>cap<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s look at the <code>commit_creds</code> function and try to understand what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">commit_creds</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>new<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>task <span class="token operator">=</span> current<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cred</span> <span class="token operator">*</span>old <span class="token operator">=</span> task<span class="token operator">-&gt;</span>real_cred<span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

        <span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>task<span class="token operator">-&gt;</span>real_cred<span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>task<span class="token operator">-&gt;</span>cred<span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>commit_creds</code> basically sets the <code>task-&gt;real_cred</code> and <code>task-&gt;cred</code> with the pointer to new <code>cred</code> structure. However, as we had passed <code>NULL</code> to <code>prepare_kernel_cred</code> address of <code>init_cred</code>.</p>
<p>This is how we get <code>root</code> and this basically means <strong>privilege escalation</strong></p>
<h2 id="selinux">SELinux </h2>
<p><strong>Security-Enhanced Linux</strong> was developed by <strong>National Security Agency (NSA)</strong> using <strong>Linux Security Modules (LSM)</strong>.</p>
<p>There are two modes of <strong>SELinux</strong></p>
<ul>
<li><strong>permissive</strong> - permission denials are <em>logged</em> but not <em>enforced</em></li>
<li><strong>enforcing</strong> - permission denials are <em>logged</em> and <em>enforced</em></li>
</ul>
<p>In <strong>Android</strong> the default mode of <strong>SELinux</strong> is <strong>enforcing</strong> and even if we get <strong>root</strong>, we are subjected to <strong>SELinux</strong> rules. </p>
<pre class="language-"><code class="lang-bash">generic_x86_64:/ $ getenforce                                                                                      
Enforcing
</code></pre>
<p>So, we need to disable <strong>SELinux</strong> as well.</p>
<h3 id="selinux-enforcing">selinux_enforcing </h3>
<p><code>selinux_enforcing</code> is a global variable which dictates whether <strong>SELinux</strong> is <strong>enforced</strong> or <strong>not</strong>. If we can figure out where <code>selinux_enforcing</code> is in memory and set it to <code>NULL</code>, then we can disable <strong>SELinux</strong> globally and now <strong>SELinux</strong> will be in <strong>permissive</strong> mode instead of <strong>enforcing</strong> mode.</p>
<h2 id="seccomp">SecComp </h2>
<p><strong>SecComp</strong> stands for <strong>Secure Computing</strong> mode and is a Linux kernel feature that allows to <strong>filter system calls</strong>. When enabled, the process can only make <strong>four</strong> system calls <code>read()</code>, <code>write()</code>, <code>exit()</code>, and <code>sigreturn()</code>.</p>
<p>When running the <strong>exploit</strong> from <code>adb</code> shell we are not subjected to <strong>seccomp</strong>. However, if we bundle the <strong>exploit</strong> in an <strong>Android</strong> application, we would be subjected to <strong>seccomp</strong>.</p>
<p>In this workshop, we are not going to look at <strong>seccomp</strong>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="environment-setup.html#android-kernel-source-code" class="navigation navigation-prev " aria-label="Previous page: Android Kernel Source Code">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="linux-privilege-escalation.html#light-weight-process" class="navigation navigation-next " aria-label="Next page: Light Weight Process">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Linux Privilege Escalation","level":"1.3","depth":1,"next":{"title":"Light Weight Process","level":"1.3.1","depth":2,"anchor":"#light-weight-process","path":"chapters/linux-privilege-escalation.md","ref":"chapters/linux-privilege-escalation.md#light-weight-process","articles":[]},"previous":{"title":"Android Kernel Source Code","level":"1.2.6","depth":2,"anchor":"#android-kernel-source-code","path":"chapters/environment-setup.md","ref":"chapters/environment-setup.md#android-kernel-source-code","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-highlight","collapsible-chapters","github","sharing","ga","prism","prism-themes"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-atom-dark.css"]},"github":{"url":"https://github.com/cloudfuzz/android-kernel-exploitation"},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"night","family":"sans","size":2},"prism-themes":{},"ga":{"configuration":"auto","token":"UA-163782039-1"},"sharing":{"all":["facebook","google","twitter","weibo","instapaper"],"facebook":true,"google":false,"instapaper":false,"twitter":true,"vk":false,"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Ashfaq Ansari (@HackSysTeam)","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Android Kernel Exploitation","gitbook":"*"},"file":{"path":"chapters/linux-privilege-escalation.md","mtime":"2020-04-20T18:14:45.387Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-04-20T18:15:25.342Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

