
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Root Cause Analysis Â· Android Kernel Exploitation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Ashfaq Ansari (@HackSysTeam)">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-atom-dark.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="root-cause-analysis.html" />
    
    
    <link rel="prev" href="scripted-privilege-escalation.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html">
            
                    
                    Environment Setup
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#hardware-requirements">
            
                    
                    Hardware Requirements
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#software-requirements">
            
                    
                    Software Requirements
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#gdb">
            
                    
                    GDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#workshop-repository">
            
                    
                    Workshop Repository
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-studio">
            
                    
                    Android Studio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-ndk">
            
                    
                    Android NDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-virtual-device">
            
                    
                    Android Virtual Device
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-kernel-source-code">
            
                    
                    Android Kernel Source Code
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html">
            
                    
                    Linux Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#light-weight-process">
            
                    
                    Light Weight Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#process-credentials">
            
                    
                    Process Credentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux">
            
                    
                    SELinux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux-enforcing">
            
                    
                    selinux_enforcing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#seccomp">
            
                    
                    SecComp
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html">
            
                    
                    Vulnerability Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#original-discovery">
            
                    
                    Original Discovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#rediscovery">
            
                    
                    Rediscovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#patch">
            
                    
                    Patch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html">
            
                    
                    Vulnerability Trigger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#reintroduction">
            
                    
                    Reintroduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#build-kernel-with-kasan">
            
                    
                    Build Kernel With KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#boot-kernel">
            
                    
                    Boot Kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#crash">
            
                    
                    Crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#kasan-symbolizer">
            
                    
                    KASan Symbolizer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html">
            
                    
                    Scripted Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html#kernel-debugging">
            
                    
                    Kernel Debugging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html">
            
                    
                    Root Cause Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash">
            
                    
                    Revisiting Crash
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-allocation">
            
                    
                    Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-free">
            
                    
                    Free
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-use">
            
                    
                    Use
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#visual-studio-code">
            
                    
                    Visual Studio Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis">
            
                    
                    Static Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-open">
            
                    
                    open
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-create">
            
                    
                    epoll_create
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-ctl">
            
                    
                    epoll_ctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ioctl">
            
                    
                    ioctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.5" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ep-remove">
            
                    
                    ep_remove
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.6" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis-recap">
            
                    
                    Static Analysis Recap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#dynamic-analysis">
            
                    
                    Dynamic Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#hw-cpu-ncore">
            
                    
                    hw.cpu.ncore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#build-kernel-without-kasan">
            
                    
                    Build Kernel Without KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#kernel-tracing">
            
                    
                    Kernel Tracing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="exploitation.html">
            
                <a href="exploitation.html">
            
                    
                    Exploitation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="exploitation.html">
            
                <a href="exploitation.html#primitive">
            
                    
                    Primitive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="exploitation.html">
            
                <a href="exploitation.html#corruption-target">
            
                    
                    Corruption Target
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="exploitation.html">
            
                <a href="exploitation.html#leaking-task-struct-pointer">
            
                    
                    Leaking task_struct*
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="exploitation.html">
            
                <a href="exploitation.html#clobber-addr-limit">
            
                    
                    Clobber addr_limit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="exploitation.html">
            
                <a href="exploitation.html#exploit-in-action">
            
                    
                    Exploit In Action
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="gdb-macros.html">
            
                <a href="gdb-macros.html">
            
                    
                    GDB Macros
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="resources.html">
            
                <a href="resources.html">
            
                    
                    Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Root Cause Analysis</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="root-cause-analysis">Root Cause Analysis</h1>
<p><strong>Root Cause Analysis (RCA)</strong> is a very important part of <strong>vulnerability research</strong>. With <strong>RCA</strong> we can determine if a <strong>crash</strong> or <strong>bug</strong> can be <strong>exploited</strong>.</p>
<p><strong>RCA</strong> is basically reverse engineering process to understanding the code that lead to the crash.</p>
<h2 id="revisiting-crash">Revisiting Crash </h2>
<p>From the crash log, we already know that it&apos;s <strong>Use after Free</strong> vulnerability. Let&apos;s revisit the crash report and try to understand why it occurred.</p>
<p>Let&apos;s strip away unwanted information and break the crash log in three parts, allocation, free and use</p>
<h3 id="revisiting-crash-allocation">Allocation </h3>
<pre class="language-"><code>[&lt;        none        &gt;] save_stack_trace+0x16/0x18 arch/x86/kernel/stacktrace.c:59
[&lt;     inline     &gt;] save_stack mm/kasan/common.c:76
[&lt;     inline     &gt;] set_track mm/kasan/common.c:85
[&lt;        none        &gt;] __kasan_kmalloc+0x133/0x1cc mm/kasan/common.c:501
[&lt;        none        &gt;] kasan_kmalloc+0x9/0xb mm/kasan/common.c:515
[&lt;        none        &gt;] kmem_cache_alloc_trace+0x1bd/0x26f mm/slub.c:2819
[&lt;     inline     &gt;] kmalloc include/linux/slab.h:488
[&lt;     inline     &gt;] kzalloc include/linux/slab.h:661
[&lt;        none        &gt;] binder_get_thread+0x166/0x6db drivers/android/binder.c:4677
[&lt;        none        &gt;] binder_poll+0x4c/0x1c2 drivers/android/binder.c:4805
[&lt;     inline     &gt;] ep_item_poll fs/eventpoll.c:888
[&lt;     inline     &gt;] ep_insert fs/eventpoll.c:1476
[&lt;     inline     &gt;] SYSC_epoll_ctl fs/eventpoll.c:2128
[&lt;        none        &gt;] SyS_epoll_ctl+0x1558/0x24f0 fs/eventpoll.c:2014
[&lt;        none        &gt;] do_syscall_64+0x19e/0x225 arch/x86/entry/common.c:292
[&lt;        none        &gt;] entry_SYSCALL_64_after_hwframe+0x3d/0xa2 arch/x86/entry/entry_64.S:233
</code></pre><p>Here is the simplified call graph.</p>
<p align="center">
  <img src="../images/crash-log-allocation-stack-trace.png" alt="Allocation Stack Trace" title="Allocation Stack Trace">
</p>

<p>Relevant source line from the PoC</p>
<pre class="language-"><code class="lang-c"><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="revisiting-crash-free">Free </h3>
<pre class="language-"><code>[&lt;        none        &gt;] save_stack_trace+0x16/0x18 arch/x86/kernel/stacktrace.c:59
[&lt;     inline     &gt;] save_stack mm/kasan/common.c:76
[&lt;     inline     &gt;] set_track mm/kasan/common.c:85
[&lt;        none        &gt;] __kasan_slab_free+0x18f/0x23f mm/kasan/common.c:463
[&lt;        none        &gt;] kasan_slab_free+0xe/0x10 mm/kasan/common.c:471
[&lt;     inline     &gt;] slab_free_hook mm/slub.c:1407
[&lt;     inline     &gt;] slab_free_freelist_hook mm/slub.c:1458
[&lt;     inline     &gt;] slab_free mm/slub.c:3039
[&lt;        none        &gt;] kfree+0x193/0x5b3 mm/slub.c:3976
[&lt;     inline     &gt;] binder_free_thread drivers/android/binder.c:4705
[&lt;        none        &gt;] binder_thread_dec_tmpref+0x192/0x1d9 drivers/android/binder.c:2053
[&lt;        none        &gt;] binder_thread_release+0x464/0x4bd drivers/android/binder.c:4794
[&lt;        none        &gt;] binder_ioctl+0x48a/0x101c drivers/android/binder.c:5062
[&lt;        none        &gt;] do_vfs_ioctl+0x608/0x106a fs/ioctl.c:46
[&lt;     inline     &gt;] SYSC_ioctl fs/ioctl.c:701
[&lt;        none        &gt;] SyS_ioctl+0x75/0xa4 fs/ioctl.c:692
[&lt;        none        &gt;] do_syscall_64+0x19e/0x225 arch/x86/entry/common.c:292
[&lt;        none        &gt;] entry_SYSCALL_64_after_hwframe+0x3d/0xa2 arch/x86/entry/entry_64.S:233
</code></pre><p>Here is the simplified call graph.</p>
<p align="center">
  <img src="../images/crash-log-free-stack-trace.png" alt="Free Stack Trace" title="Free Stack Trace">
</p>

<p>Relevant source line from the PoC</p>
<pre class="language-"><code class="lang-c"><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_THREAD_EXIT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s look at the the <code>binder_free_thread</code> implementation in <code>workshop/android-4.14-dev/goldfish/drivers/android/binder.c</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_free_thread</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We see that <code>binder_thread</code> structure is being <strong>freed</strong> by calling <code>kfree</code> which exactly matches the free call trace. This confirms that the <strong>dangling</strong> chunk is <code>binder_thread</code> structure.</p>
<p>Let&apos;s see how <code>struct binder_thread</code> is defined.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> rb_node<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> waiting_thread_node<span class="token punctuation">;</span>
        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> looper<span class="token punctuation">;</span>              <span class="token comment">/* only modified by this thread */</span>
        bool looper_need_return<span class="token punctuation">;</span> <span class="token comment">/* can be written by other thread */</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>transaction_stack<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> todo<span class="token punctuation">;</span>
        bool process_todo<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_error</span> return_error<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_error</span> reply_error<span class="token punctuation">;</span>
        wait_queue_head_t wait<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_stats</span> stats<span class="token punctuation">;</span>
        atomic_t tmp_ref<span class="token punctuation">;</span>
        bool is_dead<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>task<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="revisiting-crash-use">Use </h3>
<pre class="language-"><code>[&lt;        none        &gt;] _raw_spin_lock_irqsave+0x3a/0x5d kernel/locking/spinlock.c:160
[&lt;        none        &gt;] remove_wait_queue+0x27/0x122 kernel/sched/wait.c:50
 ?[&lt;        none        &gt;] fsnotify_unmount_inodes+0x1e8/0x1e8 fs/notify/fsnotify.c:99
[&lt;     inline     &gt;] ep_remove_wait_queue fs/eventpoll.c:612
[&lt;        none        &gt;] ep_unregister_pollwait+0x160/0x1bd fs/eventpoll.c:630
[&lt;        none        &gt;] ep_free+0x8b/0x181 fs/eventpoll.c:847
 ?[&lt;        none        &gt;] ep_eventpoll_poll+0x228/0x228 fs/eventpoll.c:942
[&lt;        none        &gt;] ep_eventpoll_release+0x48/0x54 fs/eventpoll.c:879
[&lt;        none        &gt;] __fput+0x1f2/0x51d fs/file_table.c:210
[&lt;        none        &gt;] ____fput+0x15/0x18 fs/file_table.c:244
[&lt;        none        &gt;] task_work_run+0x127/0x154 kernel/task_work.c:113
[&lt;     inline     &gt;] exit_task_work include/linux/task_work.h:22
[&lt;        none        &gt;] do_exit+0x818/0x2384 kernel/exit.c:875
 ?[&lt;        none        &gt;] mm_update_next_owner+0x52f/0x52f kernel/exit.c:468
[&lt;        none        &gt;] do_group_exit+0x12c/0x24b kernel/exit.c:978
 ?[&lt;     inline     &gt;] spin_unlock_irq include/linux/spinlock.h:367
 ?[&lt;        none        &gt;] do_group_exit+0x24b/0x24b kernel/exit.c:975
[&lt;        none        &gt;] SYSC_exit_group+0x17/0x17 kernel/exit.c:989
[&lt;        none        &gt;] SyS_exit_group+0x14/0x14 kernel/exit.c:987
[&lt;        none        &gt;] do_syscall_64+0x19e/0x225 arch/x86/entry/common.c:292
[&lt;        none        &gt;] entry_SYSCALL_64_after_hwframe+0x3d/0xa2 arch/x86/entry/entry_64.S:233
</code></pre><p>Here is the simplified call graph.</p>
<p align="center">
  <img src="../images/crash-log-use-stack-trace.png" alt="Free Stack Trace" title="Free Stack Trace">
</p>

<p>We don&apos;t see any line in the PoC which calls <code>SyS_exit_group</code>. It turns out that the <strong>use</strong> happens when the process exits, and eventually <code>exit_group</code> system call is called. This is when it tries to cleanup the resources and uses the <strong>dangling</strong> chunk erroneously.</p>
<h2 id="visual-studio-code">Visual Studio Code </h2>
<p>We will use <strong>Visual Studio Code</strong> for <strong>Android</strong> kernel source code <strong>navigation</strong>. I used this project <a href="https://github.com/amezin/vscode-linux-kernel" target="_blank">https://github.com/amezin/vscode-linux-kernel</a> for better <strong>intellisense</strong> support. </p>
<h2 id="static-analysis">Static Analysis </h2>
<p>We already know that <code>binder_thread</code> is the <strong>dangling</strong> chunk. Let&apos;s statically trace the function calls in the crashing PoC and see what&apos;s happening.</p>
<p>We want to answer the following questions:</p>
<ul>
<li>Why <code>binder_thread</code> structure was <strong>allocated</strong>?</li>
<li>Why <code>binder_thread</code> structure was <strong>freed</strong>?</li>
<li>Why the use of <code>binder_thread</code> structure happened when it&apos;s already <strong>freed</strong>?</li>
</ul>
<h3 id="syscall-open">open </h3>
<pre class="language-"><code class="lang-c">fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;/dev/binder&quot;</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/drivers/android/binder.c</code> and see how <code>open</code> system call is implemented.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> binder_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> binder_open<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>We see that <code>open</code> system call is handled by <code>binder_open</code> function.</p>
<p>Let&apos;s follow <code>binder_open</code> function and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>nodp<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        proc <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>proc<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>proc <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> proc<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>binder_open</code> allocates <code>binder_proc</code> data structure and assigns it to the <code>filp-&gt;private_data</code>.</p>
<h3 id="syscall-epoll-create">epoll_create </h3>
<pre class="language-"><code class="lang-c">epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/fs/eventpoll.c</code> and see how <code>epoll_create</code> system call is implemented. We will also follow the call graph and look into all the important functions that <code>epoll_create</code> will call.</p>
<pre class="language-"><code class="lang-c"><span class="token function">SYSCALL_DEFINE1</span><span class="token punctuation">(</span>epoll_create<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">sys_epoll_create1</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>epoll_create</code> checks if <code>size &lt;= 0</code> and then calls <code>sys_epoll_create1</code>. We can see that <code>1000</code> passed as parameter does not have any specific implications. The <code>size</code> parameter should be greater than <code>0</code>.</p>
<p>Let&apos;s follow the <code>sys_epoll_create1</code> function.</p>
<pre class="language-"><code class="lang-c"><span class="token function">SYSCALL_DEFINE1</span><span class="token punctuation">(</span>epoll_create1<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> error<span class="token punctuation">,</span> fd<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        error <span class="token operator">=</span> <span class="token function">ep_alloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        file <span class="token operator">=</span> <span class="token function">anon_inode_getfile</span><span class="token punctuation">(</span><span class="token string">&quot;[eventpoll]&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>eventpoll_fops<span class="token punctuation">,</span> ep<span class="token punctuation">,</span>
                                 O_RDWR <span class="token operator">|</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        ep<span class="token operator">-&gt;</span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
        <span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>epoll_create1</code> calls <code>ep_alloc</code>, sets <code>ep-&gt;file = file</code> and finally returns the <strong>epoll</strong> file descriptor <code>fd</code>.</p>
<p>Let&apos;s follow <code>ep_alloc</code> function and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span><span class="token operator">*</span>pep<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> error<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">user_struct</span> <span class="token operator">*</span>user<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        ep <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ep<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>poll_wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ep<span class="token operator">-&gt;</span>rdllist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ep<span class="token operator">-&gt;</span>rbr <span class="token operator">=</span> RB_ROOT_CACHED<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token operator">*</span>pep <span class="token operator">=</span> ep<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>allocates <code>struct eventpoll</code>, initializes <strong>wait queues</strong> <code>wq</code> and <code>poll_wait</code> members</li>
<li>initializes <code>rbr</code> member which is the <strong>red black tree</strong> root</li>
</ul>
<p><code>struct eventpoll</code> is the main data structure used by <strong>event polling</strong> subsystem. Let&apos;s see how <code>eventpoll</code> structure is defined in <code>workshop/android-4.14-dev/goldfish/fs/eventpoll.c</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token punctuation">{</span>
        <span class="token comment">/* Protect the access to this structure */</span>
        spinlock_t lock<span class="token punctuation">;</span>

        <span class="token comment">/*
         * This mutex is used to ensure that files are not removed
         * while epoll is using them. This is held during the event
         * collection loop, the file cleanup path, the epoll file exit
         * code and the ctl operations.
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">mutex</span> mtx<span class="token punctuation">;</span>

        <span class="token comment">/* Wait queue used by sys_epoll_wait() */</span>
        wait_queue_head_t wq<span class="token punctuation">;</span>

        <span class="token comment">/* Wait queue used by file-&gt;poll() */</span>
        wait_queue_head_t poll_wait<span class="token punctuation">;</span>

        <span class="token comment">/* List of ready file descriptors */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> rdllist<span class="token punctuation">;</span>

        <span class="token comment">/* RB tree root used to store monitored fd structs */</span>
        <span class="token keyword">struct</span> <span class="token class-name">rb_root_cached</span> rbr<span class="token punctuation">;</span>

        <span class="token comment">/*
         * This is a single linked list that chains all the &quot;struct epitem&quot; that
         * happened while transferring ready events to userspace w/out
         * holding -&gt;lock.
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>ovflist<span class="token punctuation">;</span>

        <span class="token comment">/* wakeup_source used when ep_scan_ready_list is running */</span>
        <span class="token keyword">struct</span> <span class="token class-name">wakeup_source</span> <span class="token operator">*</span>ws<span class="token punctuation">;</span>

        <span class="token comment">/* The user that created the eventpoll descriptor */</span>
        <span class="token keyword">struct</span> <span class="token class-name">user_struct</span> <span class="token operator">*</span>user<span class="token punctuation">;</span>

        <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">;</span>

        <span class="token comment">/* used to optimize loop detection check */</span>
        <span class="token keyword">int</span> visited<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> visited_list_link<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_NET_RX_BUSY_POLL</span></span>
        <span class="token comment">/* used to track busy poll napi_id */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> napi_id<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="syscall-epoll-ctl">epoll_ctl </h3>
<pre class="language-"><code class="lang-c"><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/fs/eventpoll.c</code> and see how <code>epoll_ctl</code> is implemented. We are passing <code>EPOLL_CTL_ADD</code> as the operation parameter.</p>
<pre class="language-"><code class="lang-c"><span class="token function">SYSCALL_DEFINE4</span><span class="token punctuation">(</span>epoll_ctl<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> error<span class="token punctuation">;</span>
        <span class="token keyword">int</span> full_check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">fd</span> f<span class="token punctuation">,</span> tf<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> epds<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>tep <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ep_op_has_event</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            <span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epds<span class="token punctuation">,</span> event<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epoll_event</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> error_return<span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>
        f <span class="token operator">=</span> <span class="token function">fdget</span><span class="token punctuation">(</span>epfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>f<span class="token punctuation">.</span>file<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> error_return<span class="token punctuation">;</span>

        <span class="token comment">/* Get the &quot;struct file *&quot; for the target file */</span>
        tf <span class="token operator">=</span> <span class="token function">fdget</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tf<span class="token punctuation">.</span>file<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> error_fput<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        ep <span class="token operator">=</span> f<span class="token punctuation">.</span>file<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        epi <span class="token operator">=</span> <span class="token function">ep_find</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>file<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> EPOLL_CTL_ADD<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>epi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        epds<span class="token punctuation">.</span>events <span class="token operator">|=</span> POLLERR <span class="token operator">|</span> POLLHUP<span class="token punctuation">;</span>
                        error <span class="token operator">=</span> <span class="token function">ep_insert</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epds<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>file<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> full_check<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span>
                        error <span class="token operator">=</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>copies <code>epoll_event</code> structure from <strong>user space</strong> to <strong>kernel space</strong></li>
<li>finds the corresponding <code>file</code> pointers of <code>epfd</code> and <code>fd</code> file descriptors</li>
<li>gets the pointer to <code>eventpoll</code> structure from the <code>private_data</code> member of the <code>file</code> pointer of the epoll file descriptor <code>epfd</code></li>
<li>calls <code>ep_find</code> to find the pointer to linked <code>epitem</code> structure from the <strong>red black tree</strong> node stored in <code>eventpoll</code> structure matching the file descriptor <code>fd</code></li>
<li>if <code>epitem</code> is not found for the corresponding <code>fd</code>, then it calls <code>ep_insert</code> function to allocate and link a <code>epitem</code> to <code>eventpoll</code> structure&apos;s <code>rbr</code> member</li>
</ul>
<p>Let&apos;s see how <code>struct epitem</code> is defined.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token punctuation">{</span>
        <span class="token keyword">union</span> <span class="token punctuation">{</span>
                <span class="token comment">/* RB tree node links this structure to the eventpoll RB tree */</span>
                <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> rbn<span class="token punctuation">;</span>
                <span class="token comment">/* Used to free the struct epitem */</span>
                <span class="token keyword">struct</span> <span class="token class-name">rcu_head</span> rcu<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">/* List header used to link this structure to the eventpoll ready list */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> rdllink<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Works together &quot;struct eventpoll&quot;-&gt;ovflist in keeping the
         * single linked chain of items.
         */</span>
        <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

        <span class="token comment">/* The file descriptor information this item refers to */</span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_filefd</span> ffd<span class="token punctuation">;</span>

        <span class="token comment">/* Number of active wait queue attached to poll operations */</span>
        <span class="token keyword">int</span> nwait<span class="token punctuation">;</span>

        <span class="token comment">/* List containing poll wait queues */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> pwqlist<span class="token punctuation">;</span>

        <span class="token comment">/* The &quot;container&quot; of this item */</span>
        <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>

        <span class="token comment">/* List header used to link this item to the &quot;struct file&quot; items list */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> fllink<span class="token punctuation">;</span>

        <span class="token comment">/* wakeup_source used when EPOLLWAKEUP is set */</span>
        <span class="token keyword">struct</span> <span class="token class-name">wakeup_source</span> __rcu <span class="token operator">*</span>ws<span class="token punctuation">;</span>

        <span class="token comment">/* The structure that describe the interested events and the source fd */</span>
        <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Below given diagram shows how an <code>epitem</code> structure is linked to <code>eventpoll</code> structure.</p>
<p align="center">
  <img src="../images/epitem-eventpoll-link.png" alt="epitem eventpoll link" title="epitem eventpoll link">
</p>


<p>Let&apos;s follow <code>ep_insert</code> function and see what it exactly does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_insert</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>tfile<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> full_check<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> error<span class="token punctuation">,</span> revents<span class="token punctuation">,</span> pwake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
        <span class="token keyword">long</span> user_watches<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">ep_pqueue</span> epq<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>epi <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>epi_cache<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

        <span class="token comment">/* Item initialization follow here ... */</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>rdllink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>fllink<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>pwqlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        epi<span class="token operator">-&gt;</span>ep <span class="token operator">=</span> ep<span class="token punctuation">;</span>
        <span class="token function">ep_set_ffd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>ffd<span class="token punctuation">,</span> tfile<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        epi<span class="token operator">-&gt;</span>event <span class="token operator">=</span> <span class="token operator">*</span>event<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

        <span class="token comment">/* Initialize the poll table using the queue callback */</span>
        epq<span class="token punctuation">.</span>epi <span class="token operator">=</span> epi<span class="token punctuation">;</span>
        <span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">,</span> ep_ptable_queue_proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        revents <span class="token operator">=</span> <span class="token function">ep_item_poll</span><span class="token punctuation">(</span>epi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epq<span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">ep_rbtree_insert</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>allocates a temporary structure <code>ep_pqueue</code></li>
<li>allocates <code>epitem</code> structure and initializes it</li>
<li>initializes <code>epi-&gt;pwqlist</code> member which is used to link the <strong>poll wait queues</strong></li>
<li>sets the <code>epitem</code> structure member <code>ffd-&gt;file = file</code> and <code>ffd-&gt;fd = fd</code> which is the binder&apos;s <code>file</code> structure pointer and descriptor in our case by calling <code>ep_set_ffd</code></li>
<li>sets <code>epq.epi</code> to <code>epi</code> pointer</li>
<li>sets <code>epq.pt-&gt;_qproc</code> to <code>ep_ptable_queue_proc</code> <strong>callback</strong> address</li>
<li>calls <code>ep_item_poll</code> passing <code>epi</code> and address of <code>epq.pt</code> (poll table) as arguments</li>
<li>finally, links <code>epitem</code> structure to <code>eventpoll</code> structure&apos;s <strong>red black tree</strong> root node by calling <code>ep_rbtree_insert</code> function</li>
</ul>
<p>Let&apos;s follow <code>ep_item_poll</code> and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">ep_item_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        pt<span class="token operator">-&gt;</span>_key <span class="token operator">=</span> epi<span class="token operator">-&gt;</span>event<span class="token punctuation">.</span>events<span class="token punctuation">;</span>

        <span class="token keyword">return</span> epi<span class="token operator">-&gt;</span>ffd<span class="token punctuation">.</span>file<span class="token operator">-&gt;</span>f_op<span class="token operator">-&gt;</span><span class="token function">poll</span><span class="token punctuation">(</span>epi<span class="token operator">-&gt;</span>ffd<span class="token punctuation">.</span>file<span class="token punctuation">,</span> pt<span class="token punctuation">)</span> <span class="token operator">&amp;</span> epi<span class="token operator">-&gt;</span>event<span class="token punctuation">.</span>events<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls <code>poll</code> function in the binder&apos;s <code>file</code> structure <code>f_op-&gt;poll</code> passing binder&apos;s <code>file</code> structure pointer and <code>poll_table</code> pointer</li>
</ul>
<blockquote>
<p><strong>Note:</strong> Now, we are jumping to <strong>binder</strong> subsystem from <strong>epoll</strong> subsystem.</p>
</blockquote>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/drivers/android/binder.c</code> and see how <code>poll</code> system call is implemented.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> binder_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span>poll <span class="token operator">=</span> binder_poll<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>We see that <code>poll</code> system call is handled by <code>binder_poll</code> function.</p>
<p>Let&apos;s follow <code>binder_poll</code> function and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">binder_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span>
                                <span class="token keyword">struct</span> <span class="token class-name">poll_table_struct</span> <span class="token operator">*</span>wait<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        thread <span class="token operator">=</span> <span class="token function">binder_get_thread</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>thread<span class="token punctuation">)</span>
                <span class="token keyword">return</span> POLLERR<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">poll_wait</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>wait<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>gets the pointer to <code>binder_proc</code> structure from <code>filp-&gt;private_data</code></li>
<li>calls <code>binder_get_thread</code> passing <code>binder_proc</code> structure pointer</li>
<li>finally calls <code>poll_wait</code> passing binder&apos;s <code>file</code> structure pointer, <code>&amp;thread-&gt;wait</code> which is <code>wait_queue_head_t</code> pointer and <code>poll_table_struct</code> pointer</li>
</ul>
<p>Let&apos;s first follow <code>binder_get_thread</code> and find out what it does. After that we will follow <code>poll_wait</code> function.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span><span class="token function">binder_get_thread</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>new_thread<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        thread <span class="token operator">=</span> <span class="token function">binder_get_thread_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>thread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                new_thread <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>thread<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                thread <span class="token operator">=</span> <span class="token function">binder_get_thread_ilocked</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> new_thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> thread<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>tries to get the <code>binder_thread</code> if present in <code>proc-&gt;threads.rb_node</code> by calling <code>binder_get_thread_ilocked</code></li>
<li>else it allocates a <code>binder_thread</code> structure</li>
<li>finally calls <code>binder_get_thread_ilocked</code> again, which initializes the newly allocated <code>binder_thread</code> structure and link it to the <code>proc-&gt;threads.rb_node</code> member which is basically a <strong>red black tree</strong> node</li>
</ul>
<p>If you see the call graph in <strong><a href="root-cause-analysis.html#revisiting-crash-allocation">Allocation</a></strong> section, you will find that this is where the <code>binder_thread</code> structure is <strong>allocated</strong>.</p>
<p>Now, let&apos;s follow <code>poll_wait</code> function and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">poll_wait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span> filp<span class="token punctuation">,</span> wait_queue_head_t <span class="token operator">*</span> wait_address<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">&amp;&amp;</span> p<span class="token operator">-&gt;</span>_qproc <span class="token operator">&amp;&amp;</span> wait_address<span class="token punctuation">)</span>
                p<span class="token operator">-&gt;</span><span class="token function">_qproc</span><span class="token punctuation">(</span>filp<span class="token punctuation">,</span> wait_address<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls the <strong>callback</strong> function assigned to <code>p-&gt;_qproc</code> passing binder&apos;s <code>file</code> structure pointer, <code>wait_queue_head_t</code> pointer and <code>poll_table</code> pointer</li>
</ul>
<p>If you go up and see <code>ep_insert</code> function, you will see that <code>p-&gt;_qproc</code> was set to <code>ep_ptable_queue_proc</code> function&apos;s address.</p>
<blockquote>
<p><strong>Note:</strong> Now, we are jumping back to <strong>epoll</strong> subsystem from <strong>binder</strong> subsystem.</p>
</blockquote>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/fs/eventpoll.c</code> and try to understand what <code>ep_ptable_queue_proc</code> function does.</p>
<pre class="language-"><code class="lang-c"><span class="token comment">/*
 * This is the callback that is used to add our wait queue to the
 * target file wakeup lists.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ep_ptable_queue_proc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> wait_queue_head_t <span class="token operator">*</span>whead<span class="token punctuation">,</span>
                 poll_table <span class="token operator">*</span>pt<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi <span class="token operator">=</span> <span class="token function">ep_item_from_epqueue</span><span class="token punctuation">(</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">eppoll_entry</span> <span class="token operator">*</span>pwq<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token operator">-&gt;</span>nwait <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pwq <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>pwq_cache<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">init_waitqueue_func_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>wait<span class="token punctuation">,</span> ep_poll_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pwq<span class="token operator">-&gt;</span>whead <span class="token operator">=</span> whead<span class="token punctuation">;</span>
        pwq<span class="token operator">-&gt;</span>base <span class="token operator">=</span> epi<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token operator">-&gt;</span>event<span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLEXCLUSIVE<span class="token punctuation">)</span>
            <span class="token function">add_wait_queue_exclusive</span><span class="token punctuation">(</span>whead<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">add_wait_queue</span><span class="token punctuation">(</span>whead<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>llink<span class="token punctuation">,</span> <span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>pwqlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
        epi<span class="token operator">-&gt;</span>nwait<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/* We have to signal that an error occurred */</span>
        epi<span class="token operator">-&gt;</span>nwait <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>gets pointer to <code>epitem</code> structure from <code>poll_table</code> by calling <code>ep_item_from_epqueue</code> function</li>
<li>allocates <code>eppoll_entry</code> structure and initializes it members</li>
<li>sets <code>whead</code> member of <code>eppoll_entry</code> structure to the pointer to <code>wait_queue_head_t</code> structure passed by <code>binder_poll</code>, which is basically the pointer to <code>binder_thread-&gt;wait</code></li>
<li>links <code>whead</code> (<code>binder_thread-&gt;wait</code>) to <code>eppoll_entry-&gt;wait</code> by calling <code>add_wait_queue</code></li>
<li>finally <code>eppoll_entry-&gt;llink</code> is linked to <code>epitem-&gt;pwqlist</code> by calling <code>list_add_tail</code></li>
</ul>
<blockquote>
<p><strong>Note:</strong> If you look at the code, you will notice that there are <strong>two</strong> places which holds the reference to <code>binder_thread-&gt;wait</code>. First reference is stored in <code>eppoll_entry-&gt;wait</code> and the second reference is stored in <code>eppoll_entry-&gt;whead</code>.</p>
</blockquote>
<p>Let&apos;s see how <code>struct eppoll_entry</code> is defined.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">eppoll_entry</span> <span class="token punctuation">{</span>
        <span class="token comment">/* List header used to link this structure to the &quot;struct epitem&quot; */</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> llink<span class="token punctuation">;</span>

        <span class="token comment">/* The &quot;base&quot; pointer is set to the container &quot;struct epitem&quot; */</span>
        <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>base<span class="token punctuation">;</span>

        <span class="token comment">/*
         * Wait queue item that will be linked to the target file wait
         * queue head.
         */</span>
        wait_queue_entry_t wait<span class="token punctuation">;</span>

        <span class="token comment">/* The wait queue head that linked the &quot;wait&quot; wait queue item */</span>
        wait_queue_head_t <span class="token operator">*</span>whead<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Below given diagram is the simplified call graph of how <code>binder_thread</code> structure is allocated and gets linked to <strong>epoll</strong> subsystem.</p>
<p align="center">
  <img src="../images/binder-thread-eventpoll-link-call-graph.png" alt="binder_thread eventpoll call graph" title="binder_thread eventpoll call graph">
</p>


<p>Below given diagram shows how <code>eventpoll</code> structure is connected with <code>binder_thread</code> structure.</p>
<p align="center">
  <img src="../images/eventpoll-binder-thread-link.png" alt="binder_thread eventpoll connection" title="binder_thread eventpoll connection">
</p>


<h3 id="syscall-ioctl">ioctl </h3>
<pre class="language-"><code class="lang-c"><span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BINDER_THREAD_EXIT<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/drivers/android/binder.c</code> and see how <code>ioctl</code> system call is implemented.</p>
<pre class="language-"><code>static const struct file_operations binder_fops = {
        [...]
        .unlocked_ioctl = binder_ioctl,
        .compat_ioctl = binder_ioctl,
        [...]
};
</code></pre><p>We see that <code>unlocked_ioctl</code> and <code>compat_ioctl</code> system call is handled by <code>binder_ioctl</code> function.</p>
<p>Let&apos;s follow <code>binder_ioctl</code> function and see how it handles <code>BINDER_THREAD_EXIT</code> request.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">binder_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token function">_IOC_SIZE</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">void</span> __user <span class="token operator">*</span>ubuf <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        thread <span class="token operator">=</span> <span class="token function">binder_get_thread</span><span class="token punctuation">(</span>proc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">case</span> BINDER_THREAD_EXIT<span class="token operator">:</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                <span class="token function">binder_thread_release</span><span class="token punctuation">(</span>proc<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                thread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
                ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>gets the pointer to <code>binder_thread</code> structure from <code>binder_proc</code> structure</li>
<li>calls <code>binder_thread_release</code> function passing pointers to <code>binder_proc</code> and <code>binder_thread</code> structures as the parameters</li>
</ul>
<p>Let&apos;s follow <code>binder_thread_release</code> and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">binder_thread_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">,</span>
                                 <span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">int</span> active_transactions <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> active_transactions<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p><strong>Note:</strong> Remember, we had applied a custom <em>patch</em> in this function itself to <strong>reintroduce</strong> the <strong>vulnerability</strong>.</p>
</blockquote>
<ul>
<li>interesting part of this function is that, it calls the <code>binder_thread_dec_tmpref</code> function passing pointer to <code>binder_thread</code> structure</li>
</ul>
<p>Let&apos;s follow <code>binder_thread_dec_tmpref</code> and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_thread_dec_tmpref</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thread<span class="token operator">-&gt;</span>is_dead <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread<span class="token operator">-&gt;</span>tmp_ref<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                <span class="token function">binder_free_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls <code>binder_free_thread</code> function passing pointer to <code>binder_thread</code> structure</li>
</ul>
<p>Let&apos;s follow <code>binder_free_thread</code> and find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">binder_free_thread</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token operator">*</span>thread<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls <code>kfree</code> function which frees the kernel heap chunk storing <code>binder_thread</code> structure</li>
</ul>
<p>If you see the call graph in <strong><a href="root-cause-analysis.html#revisiting-crash-free">Free</a></strong> section, you will find that this is where the <code>binder_thread</code> structure is <strong>freed</strong>.</p>
<h3 id="syscall-ep-remove">ep_remove </h3>
<p>If you see the call graph in <strong><a href="root-cause-analysis.html#revisiting-crash-use">Use</a></strong> section, you will find that <code>ep_unregister_pollwait</code> function is called when <code>exit_group</code> system call is executed. <code>exit_group</code> is usually called when the process exits. We would want to trigger the call to <code>ep_unregister_pollwait</code> at will during exploitation.</p>
<p>Let&apos;s look at <code>workshop/android-4.14-dev/goldfish/fs/eventpoll.c</code> and try to figure out how we can call <code>ep_unregister_pollwait</code> function at will. Basically, we want to inspect the callers of <code>ep_unregister_pollwait</code> function.</p>
<p>Looking at the code, I found two interesting callers functions <code>ep_remove</code> and <code>ep_free</code>. But <code>ep_remove</code> is a good candidate because can be called by <code>epoll_ctl</code> system call passing <code>EPOLL_CTL_DEL</code> as the operation parameter.</p>
<pre class="language-"><code class="lang-c"><span class="token function">SYSCALL_DEFINE4</span><span class="token punctuation">(</span>epoll_ctl<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        error <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">case</span> EPOLL_CTL_DEL<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>epi<span class="token punctuation">)</span>
                        error <span class="token operator">=</span> <span class="token function">ep_remove</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span>
                        error <span class="token operator">=</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The below given line of code can trigger <code>ep_unregister_pollwait</code> function at will.</p>
<pre class="language-"><code class="lang-c"><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s follow <code>ep_remove</code> function find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ep_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">ep_unregister_pollwait</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> epi<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls <code>ep_unregister_pollwait</code> function passing pointers to <code>eventpoll</code> and <code>epitem</code> structures as the parameters</li>
</ul>
<p>Let&apos;s follow <code>ep_unregister_pollwait</code> function find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ep_unregister_pollwait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eventpoll</span> <span class="token operator">*</span>ep<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epitem</span> <span class="token operator">*</span>epi<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>lsthead <span class="token operator">=</span> <span class="token operator">&amp;</span>epi<span class="token operator">-&gt;</span>pwqlist<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">eppoll_entry</span> <span class="token operator">*</span>pwq<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span>lsthead<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pwq <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span>lsthead<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">eppoll_entry</span><span class="token punctuation">,</span> llink<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                <span class="token function">ep_remove_wait_queue</span><span class="token punctuation">(</span>pwq<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>gets the <strong>poll wait queue</strong> <code>list_head</code> structure pointer from <code>epi-&gt;pwqlist</code>.</li>
<li>gets the pointer <code>eppoll_entry</code> from the <code>epitem-&gt;llink</code> member which of type <code>struct list_head</code></li>
<li>calls <code>ep_remove_wait_queue</code> passing pointer to <code>eppoll_entry</code> as the parameter</li>
</ul>
<p>Let&apos;s follow <code>ep_remove_wait_queue</code> function find out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ep_remove_wait_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">eppoll_entry</span> <span class="token operator">*</span>pwq<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        wait_queue_head_t <span class="token operator">*</span>whead<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        whead <span class="token operator">=</span> <span class="token function">smp_load_acquire</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>whead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>whead<span class="token punctuation">)</span>
                <span class="token function">remove_wait_queue</span><span class="token punctuation">(</span>whead<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwq<span class="token operator">-&gt;</span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>gets pointer to <code>wait_queue_head_t</code> from <code>eppoll_entry-&gt;whead</code></li>
<li>calls <code>remove_wait_queue</code> function passing pointers to <code>wait_queue_head_t</code> and <code>eppoll_entry-&gt;wait</code> as the parameters</li>
</ul>
<blockquote>
<p><strong>Note:</strong> <code>eppoll_entry-&gt;whead</code> and <code>eppoll_entry-&gt;wait</code> both has references to the <strong>dangling</strong> <code>binder_thread</code> structure.</p>
</blockquote>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/kernel/sched/wait.c</code> and follow <code>remove_wait_queue</code> function to figure out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">void</span> <span class="token function">remove_wait_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token operator">*</span>wq_entry<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>

        <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__remove_wait_queue</span><span class="token punctuation">(</span>wq_head<span class="token punctuation">,</span> wq_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_head<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls <code>spin_lock_irqsave</code> function passing pointer <code>wait_queue_head-&gt;lock</code> to acquire lock</li>
</ul>
<blockquote>
<p><strong>Note:</strong> If you look at stack trace in <strong><a href="root-cause-analysis.html#revisiting-crash-use">Use</a></strong> section, you will see that the crash occurred because <code>_raw_spin_lock_irqsave</code> used the <strong>dangling</strong> chunk. This is exactly the same place where the use of the <strong>dangling</strong> chunk happened for the first time. Remember <code>wait_queue_entry</code> also contains the references to the <strong>dangling</strong> chunk.</p>
</blockquote>
<ul>
<li>calls <code>__remove_wait_queue</code> function passing pointers to <code>wait_queue_head</code> and <code>wait_queue_entry</code> structures as the parameters</li>
</ul>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/include/linux/wait.h</code> and follow <code>__remove_wait_queue</code> function to figure out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span>
<span class="token function">__remove_wait_queue</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">wait_queue_head</span> <span class="token operator">*</span>wq_head<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">wait_queue_entry</span> <span class="token operator">*</span>wq_entry<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq_entry<span class="token operator">-&gt;</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>calls <code>list_del</code> function passing pointer to <code>wait_queue_entry-&gt;entry</code> which is of type <code>struct list_head</code> as the parameter</li>
</ul>
<blockquote>
<p><strong>Note:</strong> <code>wait_queue_head</code> is ignored and not used afterwards.</p>
</blockquote>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/include/linux/list.h</code> and follow <code>list_del</code> function to figure out what it does.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">list_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token function">__list_del_entry</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">__list_del_entry</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span>entry<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">__list_del</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span>prev<span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">__list_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span> prev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> <span class="token operator">*</span> next<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>
        <span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>prev<span class="token operator">-&gt;</span>next<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is basically <strong>unlink</strong> operation and will write a <strong>pointer</strong> to <code>binder_thread-&gt;wait.head</code> to <code>binder_thread-&gt;wait.head.next</code> and <code>binder_thread-&gt;wait.head.prev</code>, basically <strong>unlink</strong> <code>eppoll_entry-&gt;wait.entry</code> from <code>binder_thread-&gt;wait.head</code>.</p>
<p>This is a much better primitive from the point of view of <strong>exploitation</strong> than the first use of <strong>dangling chunk</strong>.</p>
<p>Below given diagrams shows how <strong>circular double linked list</strong> works so that you have better picture of what&apos;s really happening.</p>
<p>Let&apos;s see how a single initialized node <code>node1</code> looks like. In out context, <code>node1</code> is <code>binder_thread-&gt;wait.head</code> and <code>node2</code> is <code>eppoll_entry-&gt;wait.entry</code>.</p>
<p align="center">
  <img src="../images/double-link-list-single-node.png" alt="Double Link List Single Node" title="Double Link List Single Node">
</p>

<p>Now, let&apos;s see how two nodes <code>node1</code> and <code>node2</code> are linked.</p>
<p align="center">
  <img src="../images/double-link-list-two-nodes.png" alt="Double Link List Two Nodes" title="Double Link List Two Nodes">
</p>

<p>Now, let&apos;s see how <code>node1</code> node looks like when <code>node2</code> node is linked.</p>
<p align="center">
  <img src="../images/double-link-list-unlink.png" alt="Double Link List Unlink" title="Double Link List Unlink">
</p>


<h3 id="static-analysis-recap">Static Analysis Recap </h3>
<p>Let&apos;s do a recap of what we understood from the <strong>root cause analysis</strong> section.</p>
<p>In the beginning of the <strong><a href="root-cause-analysis.html#static-analysis">Static Analysis</a></strong> section we asked <strong>three</strong> questions, let&apos;s try to answer those.</p>
<ul>
<li>Why <code>binder_thread</code> structure was <strong>allocated</strong>?<ul>
<li><code>ep_insert</code> function triggers the call to <code>binder_poll</code> by calling <code>ep_item_poll</code> function</li>
<li><code>binder_poll</code> tries to find a <strong>thread</strong> to use from the <strong>red black tree</strong> node and if it&apos;s not found, a new <code>binder_thread</code> structure is allocated</li>
</ul>
</li>
</ul>
<ul>
<li>Why <code>binder_thread</code> structure was <strong>freed</strong>?<ul>
<li><code>binder_thread</code> structure is freed when <code>ioctl</code> system call is called explicitly, passing <code>BINDER_THREAD_EXIT</code> as the operation code</li>
</ul>
</li>
</ul>
<ul>
<li>Why the use of <code>binder_thread</code> structure happened when it&apos;s already <strong>freed</strong>?<ul>
<li><strong>pointer</strong> to <code>binder_thread-&gt;wait.head</code> is not removed from <code>eppoll_entry-&gt;whead</code> and <code>eppoll_entry-&gt;wait.entry</code> when <code>binder_thread</code> structure is <strong>freed</strong> explicitly</li>
<li>when the <code>eventpoll</code> is removed by calling <code>epoll_ctl</code> and passing <code>EPOLL_CTL_DEL</code> as the operation parameter, it tries to <strong>unlink</strong> all the <strong>wait queues</strong> and uses the <strong>dangling</strong> <code>binder_thread</code> structure</li>
</ul>
</li>
</ul>
<h2 id="dynamic-analysis">Dynamic Analysis </h2>
<p>In this section, we will look into how we can use <strong>GDB</strong> automation to understand the crash behavior.</p>
<p>But before we start doing that, we need to make a hardware changes to the <strong>Android Virtual Device</strong> named <strong>CVE-2019-2215</strong> we created in <strong><a href="chapters/environment-setup.md#android-virtual-device">Android Virtual Device</a></strong> section.</p>
<p>We also need to build the <strong>Android Kernel</strong> without <strong>KASan</strong>, because we don&apos;t need the <strong>KASan</strong> support now.</p>
<h3 id="hw-cpu-ncore">hw.cpu.ncore </h3>
<p>For better <strong>GDB</strong> debugging and tracing support, it&apos;s recommended to set the number of <strong>CPU cores</strong> to <strong>1</strong>.</p>
<p>Open <code>~/.android/avd/CVE-2019-2215.avd/config.ini</code> in a text editor and change line <code>hw.cpu.ncore = 4</code> to <code>hw.cpu.ncore = 1</code>.</p>
<h3 id="build-kernel-without-kasan">Build Kernel Without KASan </h3>
<p>This section is exactly same as <strong><a href="vulnerability-trigger.html#build-kernel-with-kasan">Build Kernel With KASan</a></strong>, but this time, we will use a different config file.</p>
<p>You will find the config file in <code>workshop/build-configs/goldfish.x86_64.relwithdebinfo</code> directory.</p>
<pre class="language-"><code class="lang-bash"><span class="token assign-left variable">ARCH</span><span class="token operator">=</span>x86_64
<span class="token assign-left variable">BRANCH</span><span class="token operator">=</span>relwithdebinfo

<span class="token assign-left variable">CC</span><span class="token operator">=</span>clang
<span class="token assign-left variable">CLANG_PREBUILT_BIN</span><span class="token operator">=</span>prebuilts-master/clang/host/linux-x86/clang-r377782b/bin
<span class="token assign-left variable">BUILDTOOLS_PREBUILT_BIN</span><span class="token operator">=</span>build/build-tools/path/linux-x86
<span class="token assign-left variable">CLANG_TRIPLE</span><span class="token operator">=</span>x86_64-linux-gnu-
<span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span>x86_64-linux-androidkernel-
<span class="token assign-left variable">LINUX_GCC_CROSS_COMPILE_PREBUILTS_BIN</span><span class="token operator">=</span>prebuilts/gcc/linux-x86/x86/x86_64-linux-android-4.9/bin

<span class="token assign-left variable">KERNEL_DIR</span><span class="token operator">=</span>goldfish
<span class="token assign-left variable">EXTRA_CMDS</span><span class="token operator">=</span><span class="token string">&apos;&apos;</span>
<span class="token assign-left variable">STOP_SHIP_TRACEPRINTK</span><span class="token operator">=</span><span class="token number">1</span>

<span class="token assign-left variable">FILES</span><span class="token operator">=</span><span class="token string">&quot;
arch/x86/boot/bzImage
vmlinux
System.map
&quot;</span>

<span class="token assign-left variable">DEFCONFIG</span><span class="token operator">=</span>x86_64_ranchu_defconfig
<span class="token assign-left variable">POST_DEFCONFIG_CMDS</span><span class="token operator">=</span><span class="token string">&quot;check_defconfig &amp;&amp; update_debug_config&quot;</span>

<span class="token keyword">function</span> <span class="token function-name function">update_debug_config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">${KERNEL_DIR}</span>/scripts/config --file <span class="token variable">${OUT_DIR}</span>/.config <span class="token punctuation">\</span>
         -e CONFIG_FRAME_POINTER <span class="token punctuation">\</span>
         -e CONFIG_DEBUG_INFO <span class="token punctuation">\</span>
         -d CONFIG_DEBUG_INFO_REDUCED <span class="token punctuation">\</span>
         -d CONFIG_KERNEL_LZ4 <span class="token punctuation">\</span>
         -d CONFIG_RANDOMIZE_BASE
    <span class="token punctuation">(</span>cd <span class="token variable">${OUT_DIR}</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
     <span class="token function">make</span> <span class="token assign-left variable">O</span><span class="token operator">=</span><span class="token variable">${OUT_DIR}</span> <span class="token variable">$archsubarch</span> <span class="token assign-left variable">CROSS_COMPILE</span><span class="token operator">=</span><span class="token variable">${CROSS_COMPILE}</span> olddefconfig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Now, let&apos;s use this config file and start the build process.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/android-4.14-dev$ <span class="token assign-left variable">BUILD_CONFIG</span><span class="token operator">=</span><span class="token punctuation">..</span>/build-configs/goldfish.x86_64.relwithdebinfo build/build.sh
</code></pre>
<h3 id="kernel-tracing">Kernel Tracing </h3>
<p>Our goal is to use <strong>GDB</strong> python <strong>breakpoint</strong> automation to trace function calls and dump the <code>binder_thread</code> structure chunk before and after it&apos;s <strong>freed</strong>. Also dump the same <code>binder_thread</code> structure before and after the <strong>unlink</strong> operation has been done.</p>
<p>You can find a python file <code>~/workshop/gdb/dynamic-analysis.py</code>, where I have written some debugging automation to debug this vulnerability at <strong>runtime</strong>.</p>
<p>Let&apos;s boot <strong>emulator</strong> with the newly built kernel. </p>
<blockquote>
<p><strong>Note:</strong> The <em>patch</em> to reintroduce the vulnerability is already applied.</p>
</blockquote>
<p>We need four terminal windows this time. Open the first terminal window and launch <strong>emulator</strong>.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop$ emulator -show-kernel -no-snapshot -wipe-data -avd CVE-2019-2215 -kernel ~/workshop/android-4.14-dev/out/relwithdebinfo/dist/bzImage -qemu -s -S
</code></pre>
<p>In the second window, we will use <strong>GDB</strong> to attach to the <code>qemu</code> instance.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop$ gdb -quiet ~/workshop/android-4.14-dev/out/relwithdebinfo/dist/vmlinux -ex <span class="token string">&apos;target remote :1234&apos;</span>
</code></pre>
<pre class="language-"><code>GEF for linux ready, type `gef&apos; to start, `gef config&apos; to configure
77 commands loaded for GDB 8.2 using Python engine 2.7
[*] 3 commands could not be loaded, run `gef missing` to know why.
Reading symbols from /home/ashfaq/workshop/android-4.14-dev/out/kasan/dist/vmlinux...done.
Remote debugging using :1234
warning: while parsing target description (at line 1): Could not load XML document &quot;i386-64bit.xml&quot;
warning: Could not load XML target description; ignoring
0x000000000000fff0 in exception_stacks ()
gef&gt; c
Continuing.
</code></pre><p>Once the <strong>Android</strong> is booted completely, open the third terminal window and where we will build the vulnerability trigger and push it to the <strong>virtual device</strong>.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop$ <span class="token builtin class-name">cd</span> exploit/
ashfaq@hacksys:~/workshop/exploit$ <span class="token assign-left variable">NDK_ROOT</span><span class="token operator">=</span>~/Android/Sdk/ndk/21.0.6113669 <span class="token function">make</span> build-trigger push-trigger
Building: cve-2019-2215-trigger
Pushing: cve-2019-2215-trigger to /data/local/tmp
cve-2019-2215-trigger: <span class="token number">1</span> <span class="token function">file</span> pushed, <span class="token number">0</span> skipped. <span class="token number">44.8</span> MB/s <span class="token punctuation">(</span><span class="token number">3958288</span> bytes <span class="token keyword">in</span> <span class="token number">0</span>.084s<span class="token punctuation">)</span>
</code></pre>
<p>Now, in the <strong>GDB</strong> window press <strong>CTRL+C</strong> to break in <strong>GDB</strong> so that we can load the custom python script.</p>
<p>You can find <code>dynamic-analysis.py</code> which is an automation built on top of <code>GDB</code> python scripting in <code>workshop/gdb</code>.</p>
<pre class="language-"><code>gef&gt; c
Continuing.
^C
Program received signal SIGINT, Interrupt.
native_safe_halt () at /home/ashfaq/workshop/android-4.14-dev/goldfish/arch/x86/include/asm/irqflags.h:61
61    }
gef&gt; source ~/workshop/gdb/dynamic-analysis.py
Breakpoint 1 at 0xffffffff80824047: file /home/ashfaq/workshop/android-4.14-dev/goldfish/drivers/android/binder.c, line 4701.
Breakpoint 2 at 0xffffffff802aa586: file /home/ashfaq/workshop/android-4.14-dev/goldfish/kernel/sched/wait.c, line 50.
gef&gt; c
Continuing.
</code></pre><p>Now, we can open the fourth terminal window, launch <code>adb</code> shell and run the trigger PoC.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/exploit$ adb shell
generic_x86_64:/ $ <span class="token builtin class-name">cd</span> /data/local/tmp
generic_x86_64:/data/local/tmp $ ./cve-2019-2215-trigger
generic_x86_64:/data/local/tmp $
</code></pre>
<p>As soon as you execute the trigger PoC, you will see this in the <strong>GDB</strong> terminal window. </p>
<pre class="language-"><code>binder_free_thread(thread=0xffff88800c18f200)(enter)
0xffff88800c18f200:    0xffff88806793c000    0x0000000000000001
0xffff88800c18f210:    0x0000000000000000    0x0000000000000000
0xffff88800c18f220:    0xffff88800c18f220    0xffff88800c18f220
0xffff88800c18f230:    0x0000002000001b35    0x0000000000000001
0xffff88800c18f240:    0x0000000000000000    0xffff88800c18f248
0xffff88800c18f250:    0xffff88800c18f248    0x0000000000000000
0xffff88800c18f260:    0x0000000000000000    0x0000000000000000
0xffff88800c18f270:    0x0000000000000003    0x0000000000007201
0xffff88800c18f280:    0x0000000000000000    0x0000000000000000
0xffff88800c18f290:    0x0000000000000003    0x0000000000007201
0xffff88800c18f2a0:    0x0000000000000000    0xffff88805c05cae0
0xffff88800c18f2b0:    0xffff88805c05cae0    0x0000000000000000
0xffff88800c18f2c0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2d0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2e0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2f0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f300:    0x0000000000000000    0x0000000000000000
0xffff88800c18f310:    0x0000000000000000    0x0000000000000000
0xffff88800c18f320:    0x0000000000000000    0x0000000000000000
0xffff88800c18f330:    0x0000000000000000    0x0000000000000000
0xffff88800c18f340:    0x0000000000000000    0x0000000000000000
0xffff88800c18f350:    0x0000000000000000    0x0000000000000000
0xffff88800c18f360:    0x0000000000000000    0x0000000000000000
0xffff88800c18f370:    0x0000000000000000    0x0000000000000000
0xffff88800c18f380:    0x0000000000000000    0x0000000000000001
0xffff88800c18f390:    0xffff88806d4bb200

remove_wait_queue(wq_head=0xffff88800c18f2a0, wq_entry=0xffff88805c05cac8)(enter)
0xffff88800c18f200:    0xffff88800c18f600    0x0000000000000001
0xffff88800c18f210:    0x0000000000000000    0x0000000000000000
0xffff88800c18f220:    0xffff88800c18f220    0xffff88800c18f220
0xffff88800c18f230:    0x0000002000001b35    0x0000000000000001
0xffff88800c18f240:    0x0000000000000000    0xffff88800c18f248
0xffff88800c18f250:    0xffff88800c18f248    0x0000000000000000
0xffff88800c18f260:    0x0000000000000000    0x0000000000000000
0xffff88800c18f270:    0x0000000000000003    0x0000000000007201
0xffff88800c18f280:    0x0000000000000000    0x0000000000000000
0xffff88800c18f290:    0x0000000000000003    0x0000000000007201
0xffff88800c18f2a0:    0x0000000000000000    0xffff88805c05cae0
0xffff88800c18f2b0:    0xffff88805c05cae0    0x0000000000000000
0xffff88800c18f2c0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2d0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2e0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2f0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f300:    0x0000000000000000    0x0000000000000000
0xffff88800c18f310:    0x0000000000000000    0x0000000000000000
0xffff88800c18f320:    0x0000000000000000    0x0000000000000000
0xffff88800c18f330:    0x0000000000000000    0x0000000000000000
0xffff88800c18f340:    0x0000000000000000    0x0000000000000000
0xffff88800c18f350:    0x0000000000000000    0x0000000000000000
0xffff88800c18f360:    0x0000000000000000    0x0000000000000000
0xffff88800c18f370:    0x0000000000000000    0x0000000000000000
0xffff88800c18f380:    0x0000000000000000    0x0000000000000001
0xffff88800c18f390:    0xffff88806d4bb200

Breakpoint 3 at 0xffffffff802aa5be: file /home/ashfaq/workshop/android-4.14-dev/goldfish/kernel/sched/wait.c, line 53.
remove_wait_queue_wait.c:52(exit)
0xffff88800c18f200:    0xffff88800c18f600    0x0000000000000001
0xffff88800c18f210:    0x0000000000000000    0x0000000000000000
0xffff88800c18f220:    0xffff88800c18f220    0xffff88800c18f220
0xffff88800c18f230:    0x0000002000001b35    0x0000000000000001
0xffff88800c18f240:    0x0000000000000000    0xffff88800c18f248
0xffff88800c18f250:    0xffff88800c18f248    0x0000000000000000
0xffff88800c18f260:    0x0000000000000000    0x0000000000000000
0xffff88800c18f270:    0x0000000000000003    0x0000000000007201
0xffff88800c18f280:    0x0000000000000000    0x0000000000000000
0xffff88800c18f290:    0x0000000000000003    0x0000000000007201
0xffff88800c18f2a0:    0x0000000000000000    0xffff88800c18f2a8
0xffff88800c18f2b0:    0xffff88800c18f2a8    0x0000000000000000
0xffff88800c18f2c0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2d0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2e0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f2f0:    0x0000000000000000    0x0000000000000000
0xffff88800c18f300:    0x0000000000000000    0x0000000000000000
0xffff88800c18f310:    0x0000000000000000    0x0000000000000000
0xffff88800c18f320:    0x0000000000000000    0x0000000000000000
0xffff88800c18f330:    0x0000000000000000    0x0000000000000000
0xffff88800c18f340:    0x0000000000000000    0x0000000000000000
0xffff88800c18f350:    0x0000000000000000    0x0000000000000000
0xffff88800c18f360:    0x0000000000000000    0x0000000000000000
0xffff88800c18f370:    0x0000000000000000    0x0000000000000000
0xffff88800c18f380:    0x0000000000000000    0x0000000000000001
0xffff88800c18f390:    0xffff88806d4bb200
</code></pre><p>Now, let&apos;s analyze the output and try to understand what&apos;s happening.</p>
<p>If you remember, <code>binder_free_thread</code> is the function that will eventually free the <code>binder_thread</code> structure.</p>
<p><em>After</em> <strong>free</strong> and <em>before</em> the <strong>unlink</strong> operation happens on <code>binder_thread</code> structure.</p>
<pre class="language-"><code>0xffff88800c18f2a0:    0x0000000000000000    0xffff88805c05cae0
0xffff88800c18f2b0:    0xffff88805c05cae0    0x0000000000000000
</code></pre><p><code>0xffff88800c18f2a0 + 0x8</code> is the offset of <code>binder_thread-&gt;wait.head</code> which links <code>eppoll_entry-&gt;wait.entry</code>.</p>
<pre class="language-"><code>gef&gt; p offsetof(struct binder_thread, wait.head)
$1 = 0xa8
</code></pre><p><code>0xffff88805c05cae0</code> is pointer to <code>eppoll_entry-&gt;wait.entry</code> which is of type <code>struct list_head</code>.</p>
<p><em>After</em> the <strong>unlink</strong> operation happened on <code>binder_thread</code> structure.</p>
<pre class="language-"><code>0xffff88800c18f2a0:    0x0000000000000000    0xffff88800c18f2a8
0xffff88800c18f2b0:    0xffff88800c18f2a8    0x0000000000000000
</code></pre><p>If you see closely, after the <strong>unlink</strong> operation happened, a <strong>pointer</strong> to <code>binder_thread-&gt;wait.head</code> is written to <code>binder_thread-&gt;wait.head.next</code> and <code>binder_thread-&gt;wait.head.prev</code>.</p>
<p>This is exactly what we figured out in the <strong><a href="root-cause-analysis.html#static-analysis">Static Analysis</a></strong> section.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="scripted-privilege-escalation.html#kernel-debugging" class="navigation navigation-prev " aria-label="Previous page: Kernel Debugging">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="root-cause-analysis.html#revisiting-crash" class="navigation navigation-next " aria-label="Next page: Revisiting Crash">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Root Cause Analysis","level":"1.7","depth":1,"next":{"title":"Revisiting Crash","level":"1.7.1","depth":2,"anchor":"#revisiting-crash","path":"chapters/root-cause-analysis.md","ref":"chapters/root-cause-analysis.md#revisiting-crash","articles":[{"title":"Allocation","level":"1.7.1.1","depth":3,"anchor":"#revisiting-crash-allocation","path":"chapters/root-cause-analysis.md","ref":"chapters/root-cause-analysis.md#revisiting-crash-allocation","articles":[]},{"title":"Free","level":"1.7.1.2","depth":3,"anchor":"#revisiting-crash-free","path":"chapters/root-cause-analysis.md","ref":"chapters/root-cause-analysis.md#revisiting-crash-free","articles":[]},{"title":"Use","level":"1.7.1.3","depth":3,"anchor":"#revisiting-crash-use","path":"chapters/root-cause-analysis.md","ref":"chapters/root-cause-analysis.md#revisiting-crash-use","articles":[]}]},"previous":{"title":"Kernel Debugging","level":"1.6.1","depth":2,"anchor":"#kernel-debugging","path":"chapters/scripted-privilege-escalation.md","ref":"chapters/scripted-privilege-escalation.md#kernel-debugging","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-highlight","collapsible-chapters","github","sharing","ga","prism","prism-themes"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-atom-dark.css"]},"github":{"url":"https://github.com/cloudfuzz/android-kernel-exploitation"},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"night","family":"sans","size":2},"prism-themes":{},"ga":{"configuration":"auto","token":"UA-163782039-1"},"sharing":{"all":["facebook","google","twitter","weibo","instapaper"],"facebook":true,"google":false,"instapaper":false,"twitter":true,"vk":false,"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Ashfaq Ansari (@HackSysTeam)","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Android Kernel Exploitation","gitbook":"*"},"file":{"path":"chapters/root-cause-analysis.md","mtime":"2020-12-07T08:09:25.374Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-12-07T08:10:05.383Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

