
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Vulnerability Discovery Â· Android Kernel Exploitation</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Ashfaq Ansari (@HackSysTeam)">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism-atom-dark.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="vulnerability-discovery.html" />
    
    
    <link rel="prev" href="linux-privilege-escalation.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html">
            
                    
                    Environment Setup
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="environment-setup.html">
            
                <a href="environment-setup.html#hardware-requirements">
            
                    
                    Hardware Requirements
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-studio">
            
                    
                    Android Studio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-ndk">
            
                    
                    Android NDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-virtual-device">
            
                    
                    Android Virtual Device
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="environment-setup.html">
            
                <a href="environment-setup.html#android-kernel-source-code">
            
                    
                    Android Kernel Source Code
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html">
            
                    
                    Linux Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#light-weight-process">
            
                    
                    Light Weight Process
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#process-credentials">
            
                    
                    Process Credentials
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux">
            
                    
                    SELinux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#selinux-enforcing">
            
                    
                    selinux_enforcing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="linux-privilege-escalation.html">
            
                <a href="linux-privilege-escalation.html#seccomp">
            
                    
                    SecComp
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html">
            
                    
                    Vulnerability Discovery
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#original-discovery">
            
                    
                    Original Discovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#rediscovery">
            
                    
                    Rediscovery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="vulnerability-discovery.html">
            
                <a href="vulnerability-discovery.html#patch">
            
                    
                    Patch
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html">
            
                    
                    Vulnerability Trigger
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#reintroduction">
            
                    
                    Reintroduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#build-kernel-with-kasan">
            
                    
                    Build Kernel With KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#boot-kernel">
            
                    
                    Boot Kernel
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#crash">
            
                    
                    Crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="vulnerability-trigger.html">
            
                <a href="vulnerability-trigger.html#kasan-symbolizer">
            
                    
                    KASan Symbolizer
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html">
            
                    
                    Scripted Privilege Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="scripted-privilege-escalation.html">
            
                <a href="scripted-privilege-escalation.html#kernel-debugging">
            
                    
                    Kernel Debugging
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html">
            
                    
                    Root Cause Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash">
            
                    
                    Revisiting Crash
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-allocation">
            
                    
                    Allocation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-free">
            
                    
                    Free
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.1.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#revisiting-crash-use">
            
                    
                    Use
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#visual-studio-code">
            
                    
                    Visual Studio Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis">
            
                    
                    Static Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.3.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-open">
            
                    
                    open
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-create">
            
                    
                    epoll_create
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-epoll-ctl">
            
                    
                    epoll_ctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ioctl">
            
                    
                    ioctl
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.5" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#syscall-ep-remove">
            
                    
                    ep_remove
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3.6" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#static-analysis-recap">
            
                    
                    Static Analysis Recap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#dynamic-analysis">
            
                    
                    Dynamic Analysis
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.4.1" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#hw-cpu-ncore">
            
                    
                    hw.cpu.ncore
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.2" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#build-kernel-without-kasan">
            
                    
                    Build Kernel Without KASan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4.3" data-path="root-cause-analysis.html">
            
                <a href="root-cause-analysis.html#kernel-tracing">
            
                    
                    Kernel Tracing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="exploitation.html">
            
                <a href="exploitation.html">
            
                    
                    Exploitation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="exploitation.html">
            
                <a href="exploitation.html#primitive">
            
                    
                    Primitive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="exploitation.html">
            
                <a href="exploitation.html#corruption-target">
            
                    
                    Corruption Target
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="exploitation.html">
            
                <a href="exploitation.html#leaking-task-struct-pointer">
            
                    
                    Leaking task_struct*
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="exploitation.html">
            
                <a href="exploitation.html#clobber-addr-limit">
            
                    
                    Clobber addr_limit
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="exploitation.html">
            
                <a href="exploitation.html#exploit-in-action">
            
                    
                    Exploit In Action
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="gdb-macros.html">
            
                <a href="gdb-macros.html">
            
                    
                    GDB Macros
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="resources.html">
            
                <a href="resources.html">
            
                    
                    Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Vulnerability Discovery</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="vulnerability-discovery">Vulnerability Discovery</h1>
<p>We are going to look at <code>CVE-2019-2215</code> which is a <code>Use after Free</code> vulnerability in <strong>Binder IPC</strong> subsystem.</p>
<p>This is a very <strong>severe</strong> vulnerability because <strong>binder</strong> subsystem is reachable from <strong>Chrome sandbox</strong> and can lead to privilege escalation if chained with a <strong>renderer exploit</strong>.</p>
<h2 id="original-discovery">Original Discovery </h2>
<p>This bug was initially discovered by <strong>syzbot (syzkaller bot)</strong> in the month of <strong>November 2017</strong> without a reproducer. In the month of <strong>December 2017</strong> <strong>syzbot</strong> was able to find a reproducer. You can find the original bug report here <a href="https://groups.google.com/forum/#!msg/syzkaller-bugs/QyXdgUhAF50/eLGkcwk9AQAJ" target="_blank">https://groups.google.com/forum/#!msg/syzkaller-bugs/QyXdgUhAF50/eLGkcwk9AQAJ</a></p>
<p>This bug was patched in <strong>February 2018</strong> without a <strong>CVE</strong> number. Hence, the patch was not <strong>backported</strong> to many already released devices like <strong>Pixel</strong> and <strong>Pixel 2</strong>.</p>
<h2 id="rediscovery">Rediscovery </h2>
<p>This bug was rediscovered by <strong>Maddie Stone (@maddiestone)</strong> of <strong>Project Zero</strong> based on an intelligence report from Google&apos;s <strong>Threat Analysis Group (TAG)</strong>. She reported this vulnerability on <strong>27th September 2019</strong>. You can find Maddie&apos;s report here <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=1942" target="_blank">https://bugs.chromium.org/p/project-zero/issues/detail?id=1942</a></p>
<p>The rediscovery of this bug is very interesting, <strong>Maddie</strong> documented it with the exploitation primitive here <a href="https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html" target="_blank">https://googleprojectzero.blogspot.com/2019/11/bad-binder-android-in-wild-exploit.html</a></p>
<p>I strongly suggest you all to read the blogpost, so that you know the interesting story about the rediscovery of this bug.</p>
<h2 id="patch">Patch </h2>
<p>This bug got <em>patched</em> in <code>q-goldfish-android-goldfish-4.14-dev</code> with commit id <code>7a3cee43e935b9d526ad07f20bf005ba7e74d05b</code>.</p>
<pre class="language-"><code class="lang-bash">ashfaq@hacksys:~/workshop/android-4.14-dev$ <span class="token builtin class-name">cd</span> goldfish/
ashfaq@hacksys:~/workshop/android-4.14-dev/goldfish$ <span class="token function">git</span> show 7a3cee43e935b9d526ad07f20bf005ba7e74d05b
</code></pre>
<pre class="language-"><code class="lang-diff">commit 7a3cee43e935b9d526ad07f20bf005ba7e74d05b
Author: Martijn Coenen &lt;maco@android.com&gt;
Date:   Fri Jan 5 11:27:07 2018 +0100

<span class="token unchanged">    ANDROID: binder: remove waitqueue when thread exits.
</span>
<span class="token unchanged">    commit f5cb779ba16334b45ba8946d6bfa6d9834d1527f upstream.
</span>
<span class="token unchanged">    binder_poll() passes the thread-&gt;wait waitqueue that
    can be slept on for work. When a thread that uses
    epoll explicitly exits using BINDER_THREAD_EXIT,
    the waitqueue is freed, but it is never removed
    from the corresponding epoll data structure. When
    the process subsequently exits, the epoll cleanup
    code tries to access the waitlist, which results in
    a use-after-free.
</span>
<span class="token unchanged">    Prevent this by using POLLFREE when the thread exits.
</span>
<span class="token unchanged">    Signed-off-by: Martijn Coenen &lt;maco@android.com&gt;
    Reported-by: syzbot &lt;syzkaller@googlegroups.com&gt;
    Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</span>
diff --git a/drivers/android/binder.c b/drivers/android/binder.c
index a340766b51fe..2ef8bd29e188 100644
<span class="token coord">--- a/drivers/android/binder.c</span>
<span class="token coord">+++ b/drivers/android/binder.c</span>
@@ -4302,6 +4302,18 @@ static int binder_thread_release(struct binder_proc *proc,
<span class="token unchanged">                if (t)
                        spin_lock(&amp;t-&gt;lock);
        }
</span><span class="token inserted-sign inserted">+
+       /*
+        * If this thread used poll, make sure we remove the waitqueue
+        * from any epoll data structures holding it with POLLFREE.
+        * waitqueue_active() is safe to use here because we&apos;re holding
+        * the inner lock.
+        */
+       if ((thread-&gt;looper &amp; BINDER_LOOPER_STATE_POLL) &amp;&amp;
+           waitqueue_active(&amp;thread-&gt;wait)) {
+               wake_up_poll(&amp;thread-&gt;wait, POLLHUP | POLLFREE);
+       }
+
</span><span class="token unchanged">        binder_inner_proc_unlock(thread-&gt;proc);
</span>
<span class="token unchanged">        if (send_reply)
</span></code></pre>
<blockquote>
<p><strong>Note:</strong> You won&apos;t be able to see this commit history because we did a shallow clone. However, I have a <strong>full</strong> clone of the <code>q-goldfish-android-goldfish-4.14-dev</code> branch.</p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="linux-privilege-escalation.html#seccomp" class="navigation navigation-prev " aria-label="Previous page: SecComp">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="vulnerability-discovery.html#original-discovery" class="navigation navigation-next " aria-label="Next page: Original Discovery">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Vulnerability Discovery","level":"1.4","depth":1,"next":{"title":"Original Discovery","level":"1.4.1","depth":2,"anchor":"#original-discovery","path":"chapters/vulnerability-discovery.md","ref":"chapters/vulnerability-discovery.md#original-discovery","articles":[]},"previous":{"title":"SecComp","level":"1.3.4","depth":2,"anchor":"#seccomp","path":"chapters/linux-privilege-escalation.md","ref":"chapters/linux-privilege-escalation.md#seccomp","articles":[]},"dir":"ltr"},"config":{"plugins":["-livereload","-highlight","collapsible-chapters","github","sharing","ga","prism","prism-themes"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"prism":{"css":["prism-themes/themes/prism-atom-dark.css"]},"github":{"url":"https://github.com/cloudfuzz/android-kernel-exploitation"},"search":{},"collapsible-chapters":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"night","family":"sans","size":2},"prism-themes":{},"ga":{"configuration":"auto","token":"UA-163782039-1"},"sharing":{"all":["facebook","google","twitter","weibo","instapaper"],"facebook":true,"google":false,"instapaper":false,"twitter":true,"vk":false,"weibo":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Ashfaq Ansari (@HackSysTeam)","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Android Kernel Exploitation","gitbook":"*"},"file":{"path":"chapters/vulnerability-discovery.md","mtime":"2020-04-17T09:58:02.527Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-04-17T09:58:47.775Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-chapters/collapsible-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

